# 管理者権限設定手順

管理者ユーザーを作成・管理するための手順をまとめています。

## 目次

1. [前提条件](#前提条件)
2. [既存ユーザーを管理者にする方法](#既存ユーザーを管理者にする方法)
3. [管理者権限の確認](#管理者権限の確認)
4. [ログイン方法](#ログイン方法)
5. [管理者権限の剥奪](#管理者権限の剥奪)
6. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

- Supabaseプロジェクトが設定済み
- データベースのテーブル構築が完了していること
- 少なくとも1人のユーザーがサイトで登録済みであること

---

## 既存ユーザーを管理者にする方法

### 方法1: SQLで権限を付与（推奨）

#### ステップ1: ユーザー一覧を確認

Supabase SQL Editorで以下のクエリを実行：

```sql
-- 現在のユーザー一覧を確認
SELECT 
  au.id,
  au.email,
  au.email_confirmed_at,
  up.role,
  up.display_name,
  up.created_at
FROM auth.users au
LEFT JOIN public.user_profiles up ON au.id = up.user_id
ORDER BY au.created_at DESC;
```

#### ステップ2: 管理者権限を付与

```sql
-- 方法A: メールアドレスで指定
UPDATE public.user_profiles
SET role = 'admin', updated_at = now()
WHERE user_id IN (
  SELECT id FROM auth.users WHERE email = 'your-email@example.com'
);

-- 方法B: 最新のユーザーを管理者にする
UPDATE public.user_profiles
SET role = 'admin', updated_at = now()
WHERE user_id IN (
  SELECT id FROM auth.users ORDER BY created_at DESC LIMIT 1
);
```

#### ステップ3: 確認

```sql
-- 管理者ユーザーの一覧を確認
SELECT 
  au.id,
  au.email,
  au.email_confirmed_at,
  up.role,
  up.display_name
FROM auth.users au
LEFT JOIN public.user_profiles up ON au.id = up.user_id
WHERE up.role = 'admin';
```

---

## 管理者権限の確認

### 方法1: SQLで確認

```sql
-- 特定のユーザーが管理者かどうかを確認
SELECT 
  up.user_id,
  up.display_name,
  up.role,
  au.email
FROM public.user_profiles up
LEFT JOIN auth.users au ON up.user_id = au.id
WHERE au.email = 'your-email@example.com';
```

### 方法2: サイトで確認

1. 該当ユーザーでログイン
2. 右上のユーザーアバターをクリック
3. 「🛡️ 管理者ダッシュボード」のリンクが表示されていれば、管理者権限あり
4. `/admin` にアクセスしてダッシュボードが表示されれば、管理者権限あり

---

## ログイン方法

### ステップ1: ログアウト

現在ログインしている場合は、まずログアウトしてください。

### ステップ2: 管理者アカウントでログイン

1. `http://localhost:3000/auth/login` にアクセス
2. 管理者権限を付与したメールアドレスとパスワードを入力
3. ログイン

### ステップ3: 管理者ダッシュボードにアクセス

- 方法A: ヘッダーのユーザーアバター → 「🛡️ 管理者ダッシュボード」
- 方法B: 直接URL `http://localhost:3000/admin` にアクセス

### ステップ4: ダッシュボードの確認

以下の情報が表示されれば成功：
- 総ユーザー数
- 公開プロンプト数
- 総注文数
- 総売上
- BAN済みユーザー数
- レビュー数

---

## 管理者権限の剥奪

管理者権限を剥奪（一般ユーザーに戻す）する場合：

```sql
-- 管理者権限を一般ユーザーに戻す
UPDATE public.user_profiles
SET role = 'user', updated_at = now()
WHERE user_id IN (
  SELECT id FROM auth.users WHERE email = 'admin-email@example.com'
);

-- 確認
SELECT 
  au.email,
  up.role
FROM auth.users au
LEFT JOIN public.user_profiles up ON au.id = up.user_id
WHERE au.email = 'admin-email@example.com';
```

---

## トラブルシューティング

### 問題1: ログインできない

**症状**: ログイン時に「Invalid login credentials」エラーが表示される

**原因と解決方法**:

1. **パスワードが間違っている**
   - パスワードを忘れた場合は、Supabase Dashboardからリセットメールを送信
   - Dashboard → Authentication → Users → Send password reset email

2. **メールアドレスが未確認**
   ```sql
   -- メール確認を完了
   UPDATE auth.users
   SET email_confirmed_at = now()
   WHERE email = 'your-email@example.com';
   ```

3. **ユーザーがBANされている**
   ```sql
   -- BAN状態を確認
   SELECT 
     au.email,
     au.banned_until,
     up.is_banned
   FROM auth.users au
   LEFT JOIN public.user_profiles up ON au.id = up.user_id
   WHERE au.email = 'your-email@example.com';
   
   -- BAN解除
   UPDATE auth.users
   SET banned_until = NULL
   WHERE email = 'your-email@example.com';
   
   UPDATE public.user_profiles
   SET is_banned = false
   WHERE user_id IN (
     SELECT id FROM auth.users WHERE email = 'your-email@example.com'
   );
   ```

### 問題2: 管理者権限が設定されない

**症状**: `role`が`'admin'`にならない

**解決方法**:

1. **user_profilesにレコードが存在するか確認**
   ```sql
   SELECT 
     au.id,
     au.email,
     up.user_id,
     up.role
   FROM auth.users au
   LEFT JOIN public.user_profiles up ON au.id = up.user_id
   WHERE au.email = 'your-email@example.com';
   ```

2. **user_profilesが存在しない場合は作成**
   ```sql
   -- 既存ユーザーのプロフィールを作成
   INSERT INTO public.user_profiles (
     user_id,
     display_name,
     role,
     is_banned,
     created_at,
     updated_at
   )
   SELECT 
     id,
     email,
     'user',
     false,
     created_at,
     now()
   FROM auth.users
   WHERE email = 'your-email@example.com'
   AND NOT EXISTS (
     SELECT 1 FROM public.user_profiles WHERE user_id = auth.users.id
   );
   ```

3. **user_idを直接指定して更新**
   ```sql
   -- user_idを直接指定（最も確実）
   UPDATE public.user_profiles
   SET role = 'admin', updated_at = now()
   WHERE user_id = 'actual-user-uuid-here';
   ```

### 問題3: 管理者ダッシュボードにアクセスできない

**症状**: `/admin`にアクセスするとリダイレクトされる

**原因と解決方法**:

1. **ユーザーのroleが正しく設定されているか確認**
   ```sql
   SELECT 
     au.email,
     up.role
   FROM auth.users au
   LEFT JOIN public.user_profiles up ON au.id = up.user_id
   WHERE au.email = 'your-email@example.com';
   ```

2. **ブラウザのキャッシュをクリア**
   - `Cmd + Shift + Delete`（Mac）または `Ctrl + Shift + Delete`（Windows）
   - キャッシュをクリアしてブラウザを再起動

3. **ログアウトして再度ログイン**
   - 一度ログアウトしてから、再度管理者アカウントでログイン

---

## 便利なクエリ集

### 現在の管理者数を確認

```sql
SELECT COUNT(*) as admin_count
FROM public.user_profiles
WHERE role = 'admin';
```

### 全ユーザーとそのロールを確認

```sql
SELECT 
  au.id,
  au.email,
  up.display_name,
  up.role,
  up.is_banned,
  au.email_confirmed_at,
  au.created_at
FROM auth.users au
LEFT JOIN public.user_profiles up ON au.id = up.user_id
ORDER BY au.created_at DESC;
```

### ユーザーの完全な状態を確認

```sql
SELECT 
  au.id,
  au.email,
  au.email_confirmed_at IS NOT NULL as email_confirmed,
  au.encrypted_password IS NOT NULL as has_password,
  au.banned_until,
  up.role,
  up.is_banned as profile_banned,
  up.display_name,
  up.created_at
FROM auth.users au
LEFT JOIN public.user_profiles up ON au.id = up.user_id
WHERE au.email = 'your-email@example.com';
```

---

## 注意事項

### セキュリティ

- **管理者権限は慎重に付与してください**
- 管理者ユーザーは全てのデータを閲覧・操作できます
- 本番環境では、必ず強固なパスワードを設定してください

### ベストプラクティス

1. **本番環境での初期管理者作成**
   - サイトの登録フローで自分を登録
   - その後、SQLで管理者権限を付与
   - 強固なパスワードを設定

2. **テスト環境での管理者作成**
   - テスト用ユーザーを作成
   - SQLで管理者権限を付与
   - テスト完了後は削除または権限剥奪

3. **管理者の管理**
   - 定期的に管理者ユーザーリストを確認
   - 不要な管理者権限は剥奪
   - 管理者ログの監視

---

## 参考

- [詳細設計書 - 管理者機能](./詳細設計書.md#33-管理者機能)
- [データベース設計書 - ユーザー管理](./データベース設計書.md)
- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)

---

**作成日**: 2025年10月27日  
**更新日**: 2025年10月27日  
**バージョン**: 1.0

