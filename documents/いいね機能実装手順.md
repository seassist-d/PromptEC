# いいね機能 実装手順

## 概要

プロンプトに対するいいね機能を実装しました。ユーザーはプロンプト詳細ページでいいねを追加・削除でき、いいね数はリアルタイムで更新されます。

---

## 実装内容

### 1. データベース構造

#### 1.1 既存テーブルの活用
- **`prompts`テーブル**: `like_count`カラムでいいね数を管理
- **`recommendation_events`テーブル**: ユーザーごとのいいね情報を保存
  - `user_id`: いいねを押したユーザーID
  - `prompt_id`: いいねされたプロンプトID
  - `event_type`: `'like'`を指定

#### 1.2 追加したデータベース関数

`database/05_functions.sql`に以下の関数を追加：

```sql
-- いいね数を増やす関数
CREATE OR REPLACE FUNCTION increment_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;

-- いいね数を減らす関数
CREATE OR REPLACE FUNCTION decrement_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;
```

### 2. API エンドポイント

#### 2.1 作成したファイル
`front/app/api/prompts/[id]/like/route.ts`

#### 2.2 エンドポイント仕様

**GET `/api/prompts/[id]/like`**
- **説明**: いいね状態の取得
- **認証**: 必須
- **レスポンス**:
```json
{
  "isLiked": true,
  "likeCount": 42
}
```

**POST `/api/prompts/[id]/like`**
- **説明**: いいねの追加/削除（トグル）
- **認証**: 必須
- **レスポンス**:
```json
{
  "success": true,
  "isLiked": true,
  "likeCount": 43
}
```

#### 2.3 実装ロジック
1. 認証状態を確認
2. プロンプトの存在確認
3. 既存のいいね有無をチェック
4. いいねを追加/削除
5. `recommendation_events`テーブルを更新
6. プロンプトの`like_count`を更新
7. 結果を返す

### 3. フロントエンドコンポーネント

#### 3.1 いいねボタンコンポーネント

**ファイル**: `front/components/prompts/LikeButton.tsx`

**特徴**:
- ログイン状態に応じた表示制御
- 楽観的更新（Optimistic Update）
- エラーハンドリング
- カスタマイズ可能なサイズとバリアント

**Props**:
- `promptId`: プロンプトID（必須）
- `initialLikeCount`: 初期いいね数（オプション）
- `initialIsLiked`: 初期いいね状態（オプション）
- `showCount`: いいね数を表示するか（デフォルト: true）
- `size`: ボタンサイズ（'sm' | 'md' | 'lg'、デフォルト: 'md'）
- `variant`: ボタンスタイル（'default' | 'minimal'、デフォルト: 'default'）

**使用方法**:
```tsx
<LikeButton
  promptId={prompt.id}
  initialLikeCount={prompt.like_count}
  showCount={true}
  size="md"
/>
```

#### 3.2 プロンプト詳細ページへの統合

**ファイル**: `front/components/prompts/PromptDetail.tsx`

統計情報セクション（閲覧数といいね数）にいいねボタンを追加：

```tsx
<div className="flex items-center space-x-6">
  <span className="text-sm text-gray-500">
    👁️ {prompt.view_count} 回閲覧
  </span>
  <LikeButton
    promptId={prompt.id}
    initialLikeCount={prompt.like_count}
    showCount={true}
    size="md"
  />
</div>
```

---

## 使い方

### 1. データベースマイグレーション

データベースに新しい関数を追加：

```bash
cd database
psql -U postgres -d your_database -f 05_functions.sql
```

またはSupabaseダッシュボードでSQLエディタから実行：

```sql
-- いいね数を増やす関数
CREATE OR REPLACE FUNCTION increment_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;

-- いいね数を減らす関数
CREATE OR REPLACE FUNCTION decrement_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;
```

### 2. RLS（Row Level Security）設定

`recommendation_events`テーブルへのアクセス制御を設定：

```sql
-- いいねの閲覧は本人のみ
CREATE POLICY "Users can view their own likes" 
ON public.recommendation_events
FOR SELECT USING (auth.uid() = user_id);

-- いいねの追加は認証済みユーザーのみ
CREATE POLICY "Authenticated users can add likes" 
ON public.recommendation_events
FOR INSERT 
WITH CHECK (auth.uid() = user_id AND event_type = 'like');

-- いいねの削除は本人のみ
CREATE POLICY "Users can delete their own likes" 
ON public.recommendation_events
FOR DELETE USING (auth.uid() = user_id);
```

### 3. フロントエンドのデプロイ

新しいファイルが追加されているので、デプロイしてください：

```bash
cd front
yarn build
yarn deploy
```

---

## テスト方法

### 1. 手動テスト

1. プロンプト詳細ページにアクセス
2. いいねボタンをクリック（ログインが必要）
3. いいね数が増えることを確認
4. もう一度クリックしていいねを解除
5. いいね数が減ることを確認

### 2. API テスト

**いいね状態の取得**:
```bash
curl -X GET "http://localhost:3000/api/prompts/[PROMPT_ID]/like" \
  -H "Authorization: Bearer [TOKEN]"
```

**いいねの追加/削除**:
```bash
curl -X POST "http://localhost:3000/api/prompts/[PROMPT_ID]/like" \
  -H "Authorization: Bearer [TOKEN]" \
  -H "Content-Type: application/json"
```

---

## セキュリティ考慮事項

### 1. 認証チェック
- 全てのいいねAPIは認証必須
- 未ログインユーザーはいいね不可（UIで非表示または無効化）

### 2. RLS 設定
- ユーザーは自分のいいねのみ閲覧・削除可能
- 管理者は全てのいいねを閲覧可能（将来の拡張）

### 3. バリデーション
- プロンプト存在チェック
- 重複いいね防止（1ユーザー1プロンプトにつき1いいね）
- いいね数が負の値にならないように制御

---

## パフォーマンス考慮事項

### 1. インデックス設定

`recommendation_events`テーブルにインデックスを追加：

```sql
-- ユーザーとプロンプトの組み合わせで検索を高速化
CREATE INDEX IF NOT EXISTS idx_recommendation_events_user_prompt 
ON public.recommendation_events(user_id, prompt_id, event_type);

-- プロンプト別のいいね数を高速に取得
CREATE INDEX IF NOT EXISTS idx_recommendation_events_prompt_type 
ON public.recommendation_events(prompt_id, event_type);
```

### 2. 楽観的更新
- UIは即座に更新
- エラーが発生した場合のみロールバック

### 3. キャッシング（将来の拡張）
- 人気プロンプトのいいね数をキャッシュ
- Redisを使用してユーザー別いいね状態をキャッシュ

---

## 今後の拡張

### 1. いいね一覧の取得
```typescript
GET /api/prompts/[id]/likes
```

### 2. ユーザー別いいねリスト
```typescript
GET /api/users/[userId]/likes
```

### 3. いいね通知機能
- 投稿者にいいね通知を送信
- ダッシュボードにいいね通知を表示

### 4. いいね分析
- いいねトレンド分析
- 人気プロンプトの可視化

---

## トラブルシューティング

### エラー: "関数が存在しません"
- `database/05_functions.sql`を実行して関数を作成

### エラー: "認証が必要です"
- RLSポリシーが正しく設定されているか確認
- 認証トークンが有効か確認

### いいね数が更新されない
- `recommendation_events`テーブルにデータが追加されているか確認
- データベース関数が正しく実行されているか確認

---

## 関連ファイル

- APIエンドポイント: `front/app/api/prompts/[id]/like/route.ts`
- いいねボタン: `front/components/prompts/LikeButton.tsx`
- プロンプト詳細: `front/components/prompts/PromptDetail.tsx`
- データベース関数: `database/05_functions.sql`
- データベーステーブル: `database/02_tables.sql`

---

**作成日**: 2024年
**実装者**: AI Assistant
**バージョン**: 1.0

