# ユーザー管理機能の実装手順書

## 1. 概要

管理者によるユーザー管理機能の実装手順を記載します。

### 現在の実装状況

✅ **実装済み**
- ユーザー一覧表示（基本）
- ユーザーBAN機能

❌ **未実装**
- 検索・フィルタリング機能
- ページネーション
- ユーザー詳細表示
- ユーザー統計情報表示
- ロール変更機能
- ユーザーBAN解除機能

---

## 2. データベース準備

### 2.1 マイグレーション実行

**ファイル**: `database/migrations/add_admin_actions_enhancements.sql`

```bash
# Supabase SQL Editorで以下のファイルを実行
database/migrations/add_admin_actions_enhancements.sql
```

**実行内容**:
1. `admin_action`型に`role_change`値を追加
2. `admin_actions`テーブルに`metadata`カラムを追加
3. `metadata`にGINインデックスを追加

### 2.2 確認

```sql
-- ENUM値の確認
SELECT enumlabel FROM pg_enum 
WHERE enumtypid = 'admin_action'::regtype
ORDER BY enumsortorder;

-- カラムの確認
\d admin_actions
```

---

## 3. API実装

### 3.1 ユーザー一覧・検索API（更新）

**ファイル**: `front/app/api/admin/users/route.ts`

```typescript
import { createClient } from '@/lib/supabase-server';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  try {
    const supabase = await createClient();
    
    // 管理者権限チェック
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 });
    }

    const { data: profile } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (profile?.role !== 'admin') {
      return NextResponse.json({ error: '管理者権限がありません' }, { status: 403 });
    }

    // クエリパラメータ取得
    const { searchParams } Ωnew URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '20');
    const offset = (page - 1) * limit;
    
    // フィルタリング
    const role = searchParams.get('role');
    const isBanned = searchParams.get('is_banned');
    const search = searchParams.get('search');

    let query = supabase
      .from('user_profiles')
      .select(`
        user_id,
        display_name,
        role,
        is_banned,
        created_at,
        updated_at
      `, { count: 'exact' });

    // ロールフィルタ
    if用 (role && role !== 'all') {
      query = query.eq('role', role);
    }

    // BAN状態フィルタ
    if (isBanned && isBanned !== 'all') {
      query = query.eq('is_banned', isBanned === 'true');
    }

    // 検索フィルタ（表示名）
    if (search) {
      query = query.or(`display_name.ilike.%${search}%`);
    }

    // 並び替えとページネーション
    const { data, error, count } = await query
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (error) throw error;

    return NextResponse.json({
      users: data,
      pagination: {
        total: count || 0,
        page,
        limit,
        totalPages: Math.ceil((count || 0) / limit)
      }
    });

  } catch (error: any) {
    console.error('Admin users error:', error);
    return NextResponse.json(
      { error: error.message || 'ユーザー情報の取得に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 3.2 ユーザー詳細API（新規作成）

**ファイル**: `front/app/api/admin/users/[userId]/route.ts`

```typescript
import { createClient } from '@/lib/supabase-server';
import { NextResponse } from 'next/server';

export async function GET(
  request && Request,
  { params }: { params: { userId: string } }
) {
  try {
    const supabase = await createClient();
    
    // 管理者権限チェック
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 });
    }

    const { data: profile } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (profile?.role !== 'admin') {
      return NextResponse.json({ error: '管理者権限がありません' }, { status: 403 });
    }

    const userId = params.userId;

    // ユーザープロフィール取得
    const { data: userProfile, error: profileError } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (profileError) throw profileError;

    // メールアドレス取得
    const { data: authUser } = await supabase.auth.admin.getUserById(userId);

    // 統計情報を並列取得
    const [promptsCount, ordersCount, revenue] = await Promise.all([
      // 作成したプロンプト数
      supabase
        .from('prompts')
        .select('id', { count: 'exact', head: true })
        .eq('seller_id', userId),
      
      // 購入数
      supabase
        .from('orders')
        .select('id', { count: 'exact', head: true })
        .eq('buyer_id', userId),
      
      // 売上（出品者の場合）
      supabase
        .from('ledger_entries')
        .select('amount_jpy')
        .eq('seller_id', userId)
        .eq('entry_type', 'seller_net')
    ]);

    // 売上合計を計算
    const totalRevenue = revenue.data?.reduce((sum, entry) => sum + entry.amount_jpy, 0) || 0;

    // 最近の管理アクション取得
    const { data: recentActions } = await supabase
      .from('admin_actions')
      .select('*')
      .eq('target_id', userId)
      .order('created_at', { ascending: false })
      .limit(10);

    return NextResponse.json({
      profile: userProfile,
      email: authUser?.user?.email,
      stats: {
        promptsCount: promptsCount.count || 0,
        ordersCount: ordersCount.count || 0,
        revenue: totalRevenue
      },
      recentActions: recentActions || []
    });

  } catch (error: any) {
    console.error('Admin user detail error:', error);
    return NextResponse.json(
      { error: error.message || 'ユーザー詳細の取得に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 3.3 ロール変更API（新規作成）

**ファイル**: `front/app/api/admin/users/[userId]/role/route.ts`

```typescript
import { createClient } from '@/lib/supabase-server';
import { NextResponse } from 'next/server';

export async function PUT(
  request: Request,
  { params }: { params: { userId: string } }
) {
  try {
    const supabase = await createClient();
    
    // 管理者権限チェック
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 });
    }

    const { data: profile } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (profile?.role !== 'admin') {
      return NextResponse.json({ error: '管理者権限がありません' }, { status: 403 });
    }

    const { newRole, reason } = await request.json();

    if (!newRole || !['user', 'seller', 'admin'].includes(newRole)) {
      return NextResponse.json({ error: '無効なロールです' }, { status: 400 });
    }

    // 現在のロールを取得
    const { data: targetUser } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('user_id', params.userId)
      .single();

    if (!targetUser) {
      return NextResponse.json({ error: 'ユーザーが見つかりません' }, { status: 404 });
    }

    // ロール変更
    const { error: updateError } = await supabase
      .from('user_profiles')
      .update({ 
        role: newRole,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', params.userId);

    if (updateError) throw updateError;

    // 管理者アクションを記録
    await supabase.from('admin_actions').insert({
      actor_id: user.id,
      action: 'role_change',
      target_type: 'user',
      target_id: params.userId,
      reason: reason || '管理者によるロール変更',
      metadata: {
        from_role: targetUser.role,
        to_role: newRole,
        changed_at: new Date().toISOString()
      }
    });

    return NextResponse.json({ 
      message: 'ロールを変更しました',
      newRole 
    });

  } catch (error: any) {
    console.error('Role change error:', error);
    return NextResponse.json(
      { error: error.message || 'ロール変更に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 3.4 BAN解除API（更新）

**ファイル**: `front/app/api/admin/users/[userId]/unban/route.ts`（新規作成）

```typescript
import { createClient } from '@/lib/supabase-server';
import { NextResponse } from 'next/server';

export async function PUT(
  request: Request,
  { params }: { params: { userId: string } }
) {
  try {
    const supabase = await createClient();
    
    // 管理者権限チェック
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 });
    }

    const { data: profile } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (profile?.role !== 'admin') {
      return NextResponse.json({ error: '管理者権限がありません' }, { status: 403 });
    }

    const { reason } = await request.json();

    // BAN解除
    const { error } = await supabase
      .from('user_profiles')
      .update({ 
        is_banned: false,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', params.userId);

    if (error) throw error;

    // 管理者アクションを記録
    await supabase.from('admin_actions').insert({
      actor_id: user.id,
      action: 'user_unban',
      target_type: 'user',
      target_id: params.userId,
      reason: reason || '管理者によるBAN解除',
      metadata: {
        unbanned_at: new Date().toISOString()
      }
    });

    return NextResponse.json({ message: 'BANを解除しました' });

  } catch (error: any) {
    console.error('Unban user error:', error);
    return NextResponse.json(
      { error: error.message || 'BAN解除に失敗しました' },
      { status: 500 }
    );
  }
}
```

---

## 4. フロントエンド実装

### 4.1 ユーザー管理ページの更新

**ファイル**: `front/app/admin/users/page.tsx`

主な変更点：
1. 検索・フィルタリングUI追加
2. ページネーション実装
3. ユーザー詳細モーダル追加
4. ロール変更機能追加
5. BAN解除機能追加

詳細なコードは別途提供します。

### 4.2 ユーザー詳細コンポーネント（新規作成）

**ファイル**: `front/components/admin/UserDetailModal.tsx`

### 4.3 検索・フィルタコンポーネント（新規作成）

**ファイル**: `front/components/admin/UserSearchFilters.tsx`

---

## 5. 実装チェックリスト

- [ ] データベースマイグレーション実行
- [ ] ユーザー一覧API更新（検索・フィルタリング対応）
- [ ] ユーザー詳細API作成
- [ ] ロール変更API作成
- [ ] BAN解除API作成
- [ ] ユーザー管理ページUI更新
- [ ] ユーザー詳細モーダル実装
- [ ] 検索・フィルタコンポーネント実装
- [ ] ページネーション実装
- [ ] テスト実行
- [ ] セキュリティチェック

---

## 6. テスト項目

### 6.1 機能テスト
- [ ] ユーザー一覧表示
- [ ] 検索機能
- [ ] フィルタリング機能（ロール、BAN状態）
- [ ] ページネーション
- [ ] ユーザー詳細表示
- [ ] 統計情報表示
- [ ] ロール変更
- [ ] BAN解除

### 6.2 セキュリティテスト
- [ ] 管理者以外はアクセスできない
- [ ] 未認証ユーザーはアクセスできない
- [ ] 自分自身をBANできない（オプション）
- [ ] 最後の管理者を削除できない（オプション）

---

## 7. 注意事項

### 7.1 セキュリティ
- 全てのAPIエンドポイントで管理者権限をチェック
- ロール変更は慎重に実施
- admin_actionsテーブルに全ての操作を記録

### 7.2 パフォーマンス
- ユーザー一覧はページネーション必須
- 統計情報は並列取得で高速化
- 必要に応じてキャッシュを検討

### 7.3 ユーザビリティ
- 操作前に確認ダイアログ表示
- 成功・失敗のトースト通知
- 読み込み状態の表示

---

## 8. 関連ファイル

### データベース
- `database/migrations/add_admin_actions_enhancements.sql`
- `database/01_enums_fixed.sql`
- `database/02_tables.sql`

### API
- `front/app/api/admin/users/route.ts`
- `front/app/api/admin/users/[userId]/route.ts`
- `front/app/api/admin/users/[userId]/role/route.ts`
- `front/app/api/admin/users/[userId]/unban/route.ts`

### フロントエンド
- `front/app/admin/users/page.tsx`
- `front/components/admin/UserDetailModal.tsx`
- `front/components/admin/UserSearchFilters.tsx`
