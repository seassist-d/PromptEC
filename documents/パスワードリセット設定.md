# パスワードリセット機能の設定手順

## 📋 実装完了内容

### ✅ 作成されたファイル

1. **`front/app/auth/forgot-password/page.tsx`**
   - パスワードリセットメール送信画面
   - メールアドレス入力フォーム
   - Supabaseの`resetPasswordForEmail`メソッドを使用

2. **`front/app/auth/reset-password/page.tsx`**
   - 新しいパスワード設定画面
   - パスワード入力・確認フォーム
   - Supabaseの`updateUser`メソッドを使用

## 🔧 Supabaseダッシュボード設定（重要）

以下の設定をSupabaseダッシュボードで行う必要があります。

### 1. リダイレクトURLの追加

**Authentication → Configuration → URL Configuration** に以下を追加：

**重要**: 各行に1つのURLを入力してください（改行区切り）

```
Allowed Redirect URLs:

# 既存のURL（すでに登録済み）
http://localhost:3000/auth/callback
https://gtnpbaettknxmxjwonwi.supabase.co/auth/callback

# パスワードリセット用URL（新規追加）
http://localhost:3000/auth/reset-password
https://gtnpbaettknxmxjwonwi.supabase.co/auth/reset-password
```

**登録方法（複数パターン）**:

**パターン1: 改行区切り（推奨）**
テキストエリアが改行を受け付ける場合：
```
http://localhost:3000/auth/callback
http://localhost:3000/auth/reset-password
https://gtnpbaettknxmxjwonwi.supabase.co/auth/callback
https://gtnpbaettknxmxjwonwi.supabase.co/auth/reset-password
```

**パターン2: カンマ区切り（改行できない場合）**
改行ができない場合は、カンマ区切りで入力：
```
http://localhost:3000/auth/callback,http://localhost:3000/auth/reset-password,https://gtnpbaettknxmxjwonwi.supabase.co/auth/callback,https://gtnpbaettknxmxjwonwi.supabase.co/auth/reset-password
```

**パターン3: ワイルドカード（推奨）**
開発環境と本番環境を簡単に設定：
```
http://localhost:3000/**,https://gtnpbaettknxmxjwonwi.supabase.co/**
```
この方法なら、`/auth/callback` と `/auth/reset-password` の両方が自動的に許可されます。

**手順**:
1. Supabaseダッシュボード → Authentication → Configuration → URL Configuration を開く
2. "Allowed Redirect URLs" テキストエリアに上記のいずれかの形式で入力
3. 保存ボタンをクリック

⚠️ **注意**: これらが設定されていないと、パスワードリセットリンクをクリックしたときにエラーになります。

### 2. メールテンプレートの設定（任意）

**Authentication → Configuration → Emails → Templates → Reset password** で、日本語テンプレートを設定：

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>パスワードリセット</title>
</head>
<body style="margin:0;padding:0;background:#fff;font-family:Arial, Helvetica, sans-serif;color:#111;">
  <div style="max-width:600px;margin:24px auto;padding:0 16px;">
    <h1 style="font-size:20px;line-height:1.4;margin:0 0 16px;">パスワードをリセット</h1>
    <p>PromptECのパスワードをリセットするには、以下のボタンをクリックしてください。</p>
    <table cellspacing="0" cellpadding="0" border="0" style="margin:20px 0;">
      <tr>
        <td style="border-radius:6px;background:#1a73e8;">
          <a href="{{ .ConfirmationURL }}"
             style="display:inline-block;padding:12px 20px;color:#fff;text-decoration:none;font-weight:bold;border-radius:6px;"
             target="_blank" rel="noopener">
            パスワードをリセットする
          </a>
        </td>
      </tr>
    </table>
    <p>もしボタンが機能しない場合は、次のURLをブラウザに貼り付けてください：<br>
      <a href="{{ .ConfirmationURL }}" style="color:#1a73e8;word-break:break-all;">{{ .ConfirmationURL }}</a>
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />
    <p>このリンクは1時間で無効になります。</p>
    <p>もしこのメールにお心当たりがない場合は、このメールを無視してください。</p>
    <p>株式会社SEアシスト</p>
  </div>
</body>
</html>
```

### 3. パスワードリセットリンクの有効期限設定

**Authentication → Configuration → URL Configuration** で：

- **Password Reset Link Valid For**: `3600`秒（1時間）
- または任意の有効期限を設定

## 🔄 動作フロー

### パスワードを忘れた場合

1. **ログイン画面** (`/auth/login`)
   - 「パスワードを忘れた方」リンクをクリック

2. **パスワードリセット画面** (`/auth/forgot-password`)
   - メールアドレスを入力
   - 「リセットメールを送信」ボタンをクリック

3. **Supabaseがリセットメールを送信**
   - メールアドレスが登録されている場合のみ送信
   - セキュリティのため、存在しないメールでも成功メッセージを表示

4. **メール内のリンクをクリック**
   - `/auth/reset-password` に遷移

5. **新しいパスワード設定**
   - 6文字以上のパスワードを入力
   - パスワード確認
   - 「パスワードを更新」ボタンをクリック

6. **ログイン画面へリダイレクト**
   - 成功メッセージと共にログイン画面へ
   - 新しいパスワードでログイン

## 🧪 テスト方法

1. テストアカウントでログアウト
2. ログイン画面から「パスワードを忘れた方」をクリック
3. 登録済みのメールアドレスを入力
4. メールが届くことを確認
5. メール内のリンクをクリック
6. 新しいパスワードを設定
7. 新しいパスワードでログインできることを確認

## ⚠️ セキュリティ考慮事項

1. **メールアドレスの存在チェック**
   - セキュリティのため、登録されていないメールアドレスでも成功メッセージを表示
   - これにより、悪意のあるユーザーがユーザー名の存在を推測できないようにする

2. **レート制限**
   - SupabaseのRate Limitにより、短期間に大量のリクエストは制限される
   - エラーメッセージで適切な通知が表示される

3. **パスワード要件**
   - 最低6文字以上
   - 古いパスワードと同じ場合はエラー

4. **リンクの有効期限**
   - デフォルトで1時間有効
   - 期限切れの場合は再度リセットメールを送信する必要がある

## 🔍 トラブルシューティング

### メールが届かない場合

1. **Supabaseダッシュボードでメールログを確認**
   - Authentication → Logs で送信履歴を確認

2. **迷惑メールフォルダをチェック**

3. **リダイレクトURLの設定を確認**
   - `http://localhost:3000/auth/reset-password` が登録されているか

### リンクが無効になっている場合

1. **有効期限を確認**
   - リンクは1時間で無効
   - 再度リセットメールを送信

2. **リダイレクトURLの設定を確認**
   - Supabaseダッシュボードで正しく設定されているか

### パスワード更新が失敗する場合

1. **パスワード要件を確認**
   - 6文字以上
   - 古いパスワードと異なること

2. **セッションの確認**
   - リセットリンクが有効であることを確認

## 📝 実装詳細

### 使用しているSupabaseメソッド

1. **パスワードリセットメール送信**
   ```typescript
   await supabase.auth.resetPasswordForEmail(email, {
     redirectTo: `${window.location.origin}/auth/reset-password`,
   });
   ```

2. **パスワード更新**
   ```typescript
   await supabase.auth.updateUser({
     password: password,
   });
   ```

### エラーハンドリング

- メールアドレスのバリデーション
- パスワード要件のチェック
- Supabaseエラーの日本語化
- レート制限エラーの適切な処理

## ✅ 確認事項チェックリスト

- [ ] SupabaseダッシュボードでリダイレクトURLが設定されている
- [ ] メールテンプレート（任意）が設定されている
- [ ] パスワードリセットの有効期限が設定されている
- [ ] 実際にメールが届くことを確認
- [ ] パスワード更新が正常に動作することを確認
- [ ] 新しいパスワードでログインできることを確認

