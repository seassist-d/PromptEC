Supabase Ã— Next.jsï¼šãƒ¡ãƒ¼ãƒ«èªè¨¼ï¼‹1æ™‚é–“è‡ªå‹•å‰Šé™¤ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ï¼ˆæœ€æ–°UIå¯¾å¿œï¼‰

ğŸ§­ å…¨ä½“ã®ã‚´ãƒ¼ãƒ«

æ–°è¦ç™»éŒ²ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼‰
SupabaseãŒã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã€ã‚’é€ä¿¡
ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æœ‰åŠ¹åŒ–ãƒ»ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†
1æ™‚é–“ä»¥å†…ã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œãªã‘ã‚Œã°ï¼š
ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹åŒ–ï¼ˆSupabaseã®OTPæœŸé™ï¼‰
ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œã‚‚è‡ªå‹•å‰Šé™¤ï¼ˆEdge Function + Cronï¼‰

ã€STEP 1ã€‘Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­å®šï¼ˆUIï¼‰

A. èªè¨¼ï¼ˆAuthï¼‰ã‚’æœ‰åŠ¹åŒ–

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Authentication â†’ Configuration

ã‚¿ãƒ–ã€ŒSign in / Providersã€ã‚’é–‹ã

ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹ï¼š

Enable Email providerï¼šON

Confirm emailï¼šON

**Email OTP Expirationï¼š3600ç§’ï¼ˆ1æ™‚é–“ï¼‰**

Email OTP Lengthï¼š6ã®ã¾ã¾ã§OK

â€»ã€ŒSign in / Providers â†’ Emailã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«ã€ŒEmail OTP Expirationã€ã®è¨­å®šãŒã‚ã‚Šã¾ã™ã€‚
â€» ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‚’è¸ã‚€ã¾ã§æœªç¢ºèªã®çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚
â€» 3600ç§’ã§ãƒªãƒ³ã‚¯ã¯è‡ªå‹•çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚

B. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLè¨­å®šï¼ˆæ–°UIï¼‰
Authentication â†’ Configuration â†’ URL Configuration

Site URLï¼šhttps://your-domain.com

Allowed Redirect URLsï¼š
https://your-domain.com/auth/callback

http://localhost:3000/auth/callback

â€» Allowed Redirect ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„URLã«ã¯é·ç§»ã§ãã¾ã›ã‚“ã€‚

C. ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šï¼ˆHTMLï¼‰
Authentication â†’ Configuration â†’ Emails â†’ Templates â†’ Confirm signup

ä»¥ä¸‹ã®HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ï¼ˆ{{ .ConfirmationURL }} ã¯è‡ªå‹•ã§å·®ã—è¾¼ã¾ã‚Œã¾ã™ï¼‰ã€‚

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª</title>
</head>
<body style="margin:0;padding:0;background:#fff;font-family:Arial, Helvetica, sans-serif;color:#111;">
  <div style="max-width:600px;margin:24px auto;padding:0 16px;">
    <h1 style="font-size:20px;line-height:1.4;margin:0 0 16px;">ç™»éŒ²ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™</h1>
    <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€PromptEC ã¸ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
    <table cellspacing="0" cellpadding="0" border="0" style="margin:20px 0;">
      <tr>
        <td style="border-radius:6px;background:#1a73e8;">
          <a href="{{ .ConfirmationURL }}"
             style="display:inline-block;padding:12px 20px;color:#fff;text-decoration:none;font-weight:bold;border-radius:6px;"
             target="_blank" rel="noopener">
            ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹
          </a>
        </td>
      </tr>
    </table>
    <p>ã‚‚ã—ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€æ¬¡ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š<br>
      <a href="{{ .ConfirmationURL }}" style="color:#1a73e8;word-break:break-all;">{{ .ConfirmationURL }}</a>
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />
    <p>ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“ã§ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
    <p>æ ªå¼ä¼šç¤¾SEã‚¢ã‚·ã‚¹ãƒˆï¼ˆã€‡ã€‡@seassist.co.jpï¼‰</p>
  </div>
</body>
</html>


D. ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ–¹æ³•ï¼ˆSMTPè¨­å®šï¼‰
Authentication â†’ Configuration â†’ Emails â†’ SMTP Settings

Enable Custom SMTPï¼šOFFï¼ˆå†…è”µãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ã®ã¾ã¾ã§OKï¼‰
â€» æœ¬ç•ªç§»è¡Œæ™‚ã« Resend / SendGrid ãªã©ã¸å¤‰æ›´æ¨å¥¨ã€‚

ã€STEP 2ã€‘ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆNext.jsï¼‰å´è¨­å®š

A. ç’°å¢ƒå¤‰æ•°ï¼ˆ.env.localï¼‰

NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_public_key


B. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

import { createClient } from "@supabase/supabase-js";
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export const signUp = async (email: string, password: string) => {
  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: { emailRedirectTo: "https://your-domain.com/auth/callback" },
  });
  if (error) console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error.message);
  else alert("ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚");
};


C. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆ/auth/callbackï¼‰

"use client";
import { useEffect } from "react";
import { createClient } from "@supabase/supabase-js";

export default function AuthCallback() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  useEffect(() => {
    (async () => {
      const code = new URLSearchParams(window.location.search).get("code");
      if (!code) return;
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if (error) alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      else window.location.href = "/dashboard";
    })();
  }, []);

  return <p>èªè¨¼å‡¦ç†ä¸­ã§ã™...</p>;
}

ã€STEP 3ã€‘1æ™‚é–“çµŒéã—ãŸæœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆEdge Functionï¼‰

A. é–¢æ•°ã‚’ä½œæˆ

supabase functions new cleanup-unconfirmed-users


B. é–¢æ•°ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šæ›¿ãˆï¼ˆsupabase/functions/cleanup-unconfirmed-users/index.tsï¼‰

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  const cutoff = new Date(Date.now() - MINUTES * 60 * 1000);
  let deleted = 0, page = 1;

  while (true) {
    const { data, error } = await supabase.auth.admin.listUsers({ page, perPage: 1000 });
    if (error) return new Response(error.message, { status: 500 });
    if (!data?.users.length) break;

    for (const u of data.users) {
      const isUnconfirmed = !u.email_confirmed_at;
      const createdAt = new Date(u.created_at);
      if (isUnconfirmed && createdAt < cutoff) {
        await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
        deleted++;
      }
    }
    page++;
  }

  return new Response(JSON.stringify({ deleted, cutoff: cutoff.toISOString() }), {
    headers: { "Content-Type": "application/json" },
  });
});


C. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

supabase secrets set SUPABASE_URL="https://xxxxx.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="service_role_key"
supabase secrets set CLEANUP_MINUTES="60"


D. ãƒ‡ãƒ—ãƒ­ã‚¤

supabase functions deploy cleanup-unconfirmed-users


E. Cronæ‹¡å¼µï¼ˆpg_cronï¼‰ã‚’æœ‰åŠ¹åŒ–

Supabase â†’ Integrations â†’ Cron â†’ ã€ŒEnable pg_cronã€ã‚’ã‚¯ãƒªãƒƒã‚¯
Select a schemaï¼šextensions ã‚’é¸æŠã—ã¦ç¢ºå®š

ç¢ºèªSQLï¼ˆä»»æ„ï¼‰

SELECT * FROM pg_extension WHERE extname = 'pg_cron';


F. Cronã‚¸ãƒ§ãƒ–ç™»éŒ²ï¼ˆ10åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œï¼‰

Supabase â†’ Integrations â†’ Cron â†’ Create Job

Nameï¼šcleanup-unconfirmed-users-job
Scheduleï¼š*/10 * * * *
Typeï¼šSupabase Edge Function
Methodï¼šPOST
Timeoutï¼š5000 ms
HTTP Headersï¼šç©ºæ¬„
HTTP Request Bodyï¼šç©ºæ¬„
Edge Functionï¼šcleanup-unconfirmed-users

â€» Edge Function ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€å…ˆã« deploy ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å†åº¦é–‹ãã€‚
â€» pg_net ãŒå¿…è¦ãªå ´åˆã€ã€ŒInstall pg_net extensionã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚

ã€STEP 4ã€‘ãƒ†ã‚¹ãƒˆæ–¹æ³•

ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ signUp() ã‚’å®Ÿè¡Œ

Supabase â†’ Authentication â†’ Users ã«ã€Œemail_confirmed_at = nullã€ã®æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹

ãƒ¡ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã›ãšæ”¾ç½®

ç´„1æ™‚é–“å¾Œã€Cronå®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## 1æ™‚é–“è‡ªå‹•å‰Šé™¤æ©Ÿèƒ½

### âœ… å®Ÿè£…å†…å®¹

1. **Edge Functionä½œæˆ**: `cleanup-unconfirmed-users`
2. **1æ™‚é–“è‡ªå‹•å‰Šé™¤**: æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’1æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤
3. **Cronè¨­å®š**: 10åˆ†ã”ã¨ã«å®Ÿè¡Œã—ã¦æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯

### âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
supabase/
â””â”€â”€ functions/
    â””â”€â”€ cleanup-unconfirmed-users/
        â”œâ”€â”€ index.ts                    # 1æ™‚é–“è‡ªå‹•å‰Šé™¤ã®Edge Function
        â””â”€â”€ .env.example               # ç’°å¢ƒå¤‰æ•°ã®ä¾‹
```

### âœ… Edge Functionã®æ©Ÿèƒ½

```typescript
// 1æ™‚é–“ = 60åˆ†
const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

// æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆemail_confirmed_at = nullï¼‰ã‹ã¤
// ä½œæˆã‹ã‚‰1æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤
const isUnconfirmed = !u.email_confirmed_at;
const createdAt = new Date(u.created_at);
if (isUnconfirmed && createdAt < cutoff) {
  await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
  deleted++;
}
```

### âœ… å¿…è¦ãªè¨­å®šï¼ˆSupabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰

**Authentication â†’ Configuration â†’ Sign in / Providers â†’ Email** ã§ï¼š
- **Email OTP Expiration**: `3600` ç§’ï¼ˆ1æ™‚é–“ï¼‰

**Authentication â†’ Configuration â†’ Emails â†’ Templates** ã§ï¼š
- **Confirm signup ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ã€Œã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“ã§ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã€ã‚’è¿½åŠ 

**Integrations â†’ Cron â†’ New Job** ã§ï¼š
- **Function**: `cleanup-unconfirmed-users`
- **Schedule**: `*/10 * * * *`ï¼ˆ10åˆ†ã”ã¨ï¼‰

### âœ… ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
supabase secrets set SUPABASE_URL="https://gtnpbaettknxmxjwonwi.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="your_service_role_key"
supabase secrets set CLEANUP_MINUTES="60"
```

### âœ… ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
supabase functions deploy cleanup-unconfirmed-users
```

### âœ… å‹•ä½œãƒ•ãƒ­ãƒ¼

1. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›** â†’ ã€Œç¶šè¡Œã€
2. **Supabaseã§ä»®ç™»éŒ²** â†’ `email_confirmed_at: null`
3. **ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡** â†’ **1æ™‚é–“ã§ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹**
4. **1æ™‚é–“ä»¥å†…ã«ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯** â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºå®š
5. **1æ™‚é–“çµŒéå¾Œ** â†’ Edge FunctionãŒæœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤

### âœ… ãƒ†ã‚¹ãƒˆæ–¹æ³•

1. ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§æ–°è¦ç™»éŒ²
2. ãƒ¡ãƒ¼ãƒ«ã‚’æ”¾ç½®ï¼ˆãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãªã„ï¼‰
3. 1æ™‚é–“å¾Œã€Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“‹ å®Ÿè£…å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—

### âœ… 1. ãƒ¡ãƒ¼ãƒ«èªè¨¼UIã®å®Ÿè£…
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `front/components/auth/EmailAuthForm.tsx`
- **æ©Ÿèƒ½**: æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¡ãƒ¼ãƒ«å…¥åŠ› â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼‰
- **çŠ¶æ…‹ç®¡ç†**: `emailSent`çŠ¶æ…‹ã§ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å¾Œã®UIè¡¨ç¤º

### âœ… 2. Supabaseãƒ¡ãƒ¼ãƒ«èªè¨¼ã®çµ±åˆ
- **ãƒ¡ã‚½ãƒƒãƒ‰**: `supabase.auth.signUp()`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¨ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: `emailRedirectTo: ${window.location.origin}/auth/callback?source=register`
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æ—¥æœ¬èªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º

### âœ… 3. ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `front/app/auth/callback/page.tsx`
- **å‡¦ç†**: `code`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å—ä¿¡ã¨ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **ãƒ•ãƒ­ãƒ¼**: æ–°è¦ç™»éŒ²æ™‚ã¯`/profile/setup`ã¸ã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯`/`ã¸

### âœ… 4. 1æ™‚é–“æœ‰åŠ¹æœŸé™ã®è¨­å®š
- **Supabaseè¨­å®š**: Authentication â†’ Configuration â†’ Sign in / Providers â†’ Email â†’ Email OTP Expiration = 3600ç§’ï¼ˆ1æ™‚é–“ï¼‰
- **ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ã€Œã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“ã§ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã€ã‚’è¿½åŠ 
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL**: `http://localhost:3000/auth/callback`ã‚’è¿½åŠ 

### âœ… 5. æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•å‰Šé™¤Edge Function
- **é–¢æ•°å**: `cleanup-unconfirmed-users`
- **æ©Ÿèƒ½**: 1æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸæœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ`email_confirmed_at: null`ï¼‰ã‚’è‡ªå‹•å‰Šé™¤
- **ç’°å¢ƒå¤‰æ•°**: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `CLEANUP_MINUTES`

### âœ… 6. Cronã‚¸ãƒ§ãƒ–ã®è¨­å®š
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: `*/10 * * * *`ï¼ˆ10åˆ†ã”ã¨ï¼‰
- **ã‚¿ã‚¤ãƒ—**: Supabase Edge Function
- **å¯¾è±¡**: `cleanup-unconfirmed-users`é–¢æ•°

### âœ… 7. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- **Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: Settings â†’ Edge Functions â†’ Add new secret
- **è¨­å®šæ¸ˆã¿**:
  - `SUPABASE_URL`: `https://gtnpbaettknxmxjwonwi.supabase.co`
  - `SUPABASE_SERVICE_ROLE_KEY`: ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼
  - `CLEANUP_MINUTES`: `60`

---

## ğŸ¯ æœ€çµ‚çš„ãªå‹•ä½œãƒ•ãƒ­ãƒ¼

1. **æ–°è¦ç™»éŒ²ç”»é¢**ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
2. **ã€Œç¶šè¡Œã€**ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ Supabaseã§ä»®ç™»éŒ²ï¼ˆ`email_confirmed_at: null`ï¼‰
3. **ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡** â†’ 1æ™‚é–“ã§ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹åŒ–
4. **ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯** â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºå®šï¼ˆ`email_confirmed_at: è¨­å®š`ï¼‰
5. **1æ™‚é–“çµŒéå¾Œ** â†’ Edge FunctionãŒæœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤

**âœ… ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®1æ™‚é–“è‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ãŒå®Œå…¨ã«å®Ÿè£…ã•ã‚Œã¾ã—ãŸï¼**