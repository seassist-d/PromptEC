Supabase × Next.js：メール認証＋1時間自動削除セットアップ手順（最新UI対応）

🧭 全体のゴール

新規登録（メール＋パスワード入力）
Supabaseが「確認メール」を送信
リンクをクリック → 有効化・ログイン完了
1時間以内にクリックされなければ：
リンクが無効化（SupabaseのOTP期限）
ユーザー行も自動削除（Edge Function + Cron）

【STEP 1】Supabase ダッシュボード設定（UI）

A. 認証（Auth）を有効化

Supabaseダッシュボード → Authentication → Configuration

タブ「Sign in / Providers」を開く

以下を設定する：

Enable Email provider：ON

Confirm email：ON

**Email OTP Expiration：3600秒（1時間）**

Email OTP Length：6のままでOK

※「Sign in / Providers → Email」セクション内に「Email OTP Expiration」の設定があります。
※ メールリンクを踏むまで未確認の状態になります。
※ 3600秒でリンクは自動的に無効化されます。

B. リダイレクトURL設定（新UI）
Authentication → Configuration → URL Configuration

Site URL：https://your-domain.com

Allowed Redirect URLs：
https://your-domain.com/auth/callback

http://localhost:3000/auth/callback

※ Allowed Redirect に登録されていないURLには遷移できません。

C. メールテンプレート設定（HTML）
Authentication → Configuration → Emails → Templates → Confirm signup

以下のHTMLを貼り付けて保存します（{{ .ConfirmationURL }} は自動で差し込まれます）。

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サインアップ確認</title>
</head>
<body style="margin:0;padding:0;background:#fff;font-family:Arial, Helvetica, sans-serif;color:#111;">
  <div style="max-width:600px;margin:24px auto;padding:0 16px;">
    <h1 style="font-size:20px;line-height:1.4;margin:0 0 16px;">登録の確認をお願いします</h1>
    <p>以下のボタンをクリックして、PromptEC への登録を完了してください。</p>
    <table cellspacing="0" cellpadding="0" border="0" style="margin:20px 0;">
      <tr>
        <td style="border-radius:6px;background:#1a73e8;">
          <a href="{{ .ConfirmationURL }}"
             style="display:inline-block;padding:12px 20px;color:#fff;text-decoration:none;font-weight:bold;border-radius:6px;"
             target="_blank" rel="noopener">
            登録を完了する
          </a>
        </td>
      </tr>
    </table>
    <p>もしボタンが機能しない場合は、次のURLをブラウザに貼り付けてください：<br>
      <a href="{{ .ConfirmationURL }}" style="color:#1a73e8;word-break:break-all;">{{ .ConfirmationURL }}</a>
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />
    <p>このリンクは1時間で無効になります。</p>
    <p>株式会社SEアシスト（〇〇@seassist.co.jp）</p>
  </div>
</body>
</html>


D. メール送信方法（SMTP設定）
Authentication → Configuration → Emails → SMTP Settings

Enable Custom SMTP：OFF（内蔵メール機能のままでOK）
※ 本番移行時に Resend / SendGrid などへ変更推奨。

【STEP 2】ローカル（Next.js）側設定

A. 環境変数（.env.local）

NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_public_key


B. サインアップ処理

import { createClient } from "@supabase/supabase-js";
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export const signUp = async (email: string, password: string) => {
  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: { emailRedirectTo: "https://your-domain.com/auth/callback" },
  });
  if (error) console.error("登録エラー:", error.message);
  else alert("確認メールを送信しました。メール内のリンクをクリックしてください。");
};


C. コールバック処理（/auth/callback）

"use client";
import { useEffect } from "react";
import { createClient } from "@supabase/supabase-js";

export default function AuthCallback() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  useEffect(() => {
    (async () => {
      const code = new URLSearchParams(window.location.search).get("code");
      if (!code) return;
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if (error) alert("認証に失敗しました");
      else window.location.href = "/dashboard";
    })();
  }, []);

  return <p>認証処理中です...</p>;
}

【STEP 3】1時間経過した未確認ユーザーを自動削除（Edge Function）

A. 関数を作成

supabase functions new cleanup-unconfirmed-users


B. 関数コードを貼り替え（supabase/functions/cleanup-unconfirmed-users/index.ts）

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  const cutoff = new Date(Date.now() - MINUTES * 60 * 1000);
  let deleted = 0, page = 1;

  while (true) {
    const { data, error } = await supabase.auth.admin.listUsers({ page, perPage: 1000 });
    if (error) return new Response(error.message, { status: 500 });
    if (!data?.users.length) break;

    for (const u of data.users) {
      const isUnconfirmed = !u.email_confirmed_at;
      const createdAt = new Date(u.created_at);
      if (isUnconfirmed && createdAt < cutoff) {
        await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
        deleted++;
      }
    }
    page++;
  }

  return new Response(JSON.stringify({ deleted, cutoff: cutoff.toISOString() }), {
    headers: { "Content-Type": "application/json" },
  });
});


C. 環境変数を設定

supabase secrets set SUPABASE_URL="https://xxxxx.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="service_role_key"
supabase secrets set CLEANUP_MINUTES="60"


D. デプロイ

supabase functions deploy cleanup-unconfirmed-users


E. Cron拡張（pg_cron）を有効化

Supabase → Integrations → Cron → 「Enable pg_cron」をクリック
Select a schema：extensions を選択して確定

確認SQL（任意）

SELECT * FROM pg_extension WHERE extname = 'pg_cron';


F. Cronジョブ登録（10分ごとに自動実行）

Supabase → Integrations → Cron → Create Job

Name：cleanup-unconfirmed-users-job
Schedule：*/10 * * * *
Type：Supabase Edge Function
Method：POST
Timeout：5000 ms
HTTP Headers：空欄
HTTP Request Body：空欄
Edge Function：cleanup-unconfirmed-users

※ Edge Function が表示されない場合は、先に deploy コマンドを実行してから再度開く。
※ pg_net が必要な場合、「Install pg_net extension」をクリックして有効化する。

【STEP 4】テスト方法

テスト用のメールアドレスで signUp() を実行

Supabase → Authentication → Users に「email_confirmed_at = null」の未確認ユーザーが作成される

メールをクリックせず放置

約1時間後、Cron実行タイミングで自動削除されることを確認

---

## 1時間自動削除機能

### ✅ 実装内容

1. **Edge Function作成**: `cleanup-unconfirmed-users`
2. **1時間自動削除**: 未確認ユーザーを1時間後に自動削除
3. **Cron設定**: 10分ごとに実行して未確認ユーザーをチェック

### ✅ ファイル構成

```
supabase/
└── functions/
    └── cleanup-unconfirmed-users/
        ├── index.ts                    # 1時間自動削除のEdge Function
        └── .env.example               # 環境変数の例
```

### ✅ Edge Functionの機能

```typescript
// 1時間 = 60分
const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

// 未確認ユーザー（email_confirmed_at = null）かつ
// 作成から1時間以上経過したユーザーを自動削除
const isUnconfirmed = !u.email_confirmed_at;
const createdAt = new Date(u.created_at);
if (isUnconfirmed && createdAt < cutoff) {
  await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
  deleted++;
}
```

### ✅ 必要な設定（Supabaseダッシュボード）

**Authentication → Configuration → Sign in / Providers → Email** で：
- **Email OTP Expiration**: `3600` 秒（1時間）

**Authentication → Configuration → Emails → Templates** で：
- **Confirm signup テンプレート**: 「このリンクは1時間で無効になります。」を追加

**Integrations → Cron → New Job** で：
- **Function**: `cleanup-unconfirmed-users`
- **Schedule**: `*/10 * * * *`（10分ごと）

### ✅ 環境変数設定

```bash
supabase secrets set SUPABASE_URL="https://gtnpbaettknxmxjwonwi.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="your_service_role_key"
supabase secrets set CLEANUP_MINUTES="60"
```

### ✅ デプロイ

```bash
supabase functions deploy cleanup-unconfirmed-users
```

### ✅ 動作フロー

1. **メールアドレス + パスワード入力** → 「続行」
2. **Supabaseで仮登録** → `email_confirmed_at: null`
3. **確認メール送信** → **1時間でリンクが無効**
4. **1時間以内にリンククリック** → アカウント確定
5. **1時間経過後** → Edge Functionが未確認ユーザーを自動削除

### ✅ テスト方法

1. テストメールで新規登録
2. メールを放置（リンクをクリックしない）
3. 1時間後、Supabaseダッシュボードでユーザーが削除されていることを確認

---

## 📋 実装完了ステップ

### ✅ 1. メール認証UIの実装
- **ファイル**: `front/components/auth/EmailAuthForm.tsx`
- **機能**: 段階的フォーム（メール入力 → パスワード入力）
- **状態管理**: `emailSent`状態で確認メール送信後のUI表示

### ✅ 2. Supabaseメール認証の統合
- **メソッド**: `supabase.auth.signUp()`でユーザー登録と確認メール送信
- **リダイレクト**: `emailRedirectTo: ${window.location.origin}/auth/callback?source=register`
- **エラーハンドリング**: 日本語エラーメッセージの表示

### ✅ 3. メール確認コールバック処理
- **ファイル**: `front/app/auth/callback/page.tsx`
- **処理**: `code`パラメータの受信と直接リダイレクト
- **フロー**: 新規登録時は`/profile/setup`へ、既存ユーザーは`/`へ

### ✅ 4. 1時間有効期限の設定
- **Supabase設定**: Authentication → Configuration → Sign in / Providers → Email → Email OTP Expiration = 3600秒（1時間）
- **メールテンプレート**: 「このリンクは1時間で無効になります。」を追加
- **リダイレクトURL**: `http://localhost:3000/auth/callback`を追加

### ✅ 5. 未確認ユーザー自動削除Edge Function
- **関数名**: `cleanup-unconfirmed-users`
- **機能**: 1時間以上経過した未確認ユーザー（`email_confirmed_at: null`）を自動削除
- **環境変数**: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `CLEANUP_MINUTES`

### ✅ 6. Cronジョブの設定
- **スケジュール**: `*/10 * * * *`（10分ごと）
- **タイプ**: Supabase Edge Function
- **対象**: `cleanup-unconfirmed-users`関数

### ✅ 7. 環境変数の設定
- **Supabaseダッシュボード**: Settings → Edge Functions → Add new secret
- **設定済み**:
  - `SUPABASE_URL`: `https://gtnpbaettknxmxjwonwi.supabase.co`
  - `SUPABASE_SERVICE_ROLE_KEY`: サービスロールキー
  - `CLEANUP_MINUTES`: `60`

---

## 🎯 最終的な動作フロー

1. **新規登録画面**でメールアドレスとパスワードを入力
2. **「続行」**をクリック → Supabaseで仮登録（`email_confirmed_at: null`）
3. **確認メール送信** → 1時間でリンクが無効化
4. **メール内のリンクをクリック** → アカウント確定（`email_confirmed_at: 設定`）
5. **1時間経過後** → Edge Functionが未確認ユーザーを自動削除

**✅ メール認証の1時間自動削除機能が完全に実装されました！**