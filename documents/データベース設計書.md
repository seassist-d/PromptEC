データベース設計書（Supabase / PostgreSQL）
0. 設計ポリシー（要点）

認証は auth.users（Supabase）を前提。アプリ側プロフィールは user_profiles に分離。

決済は抽象化レイヤ（payments, payment_providers）で多決済（カード/PayPal/PayPay）に対応。

売上還元は台帳型（ledger_entries）で厳密に履歴管理し、出品者残高は seller_balances で集計。

商品（プロンプト）はバージョン管理（prompt_versions）と配布実体（prompt_assets）を分離。

購入者の再ダウンロード権は entitlements（購入時点スナップショット紐付け）で永続化。

AI SDK 連携は ai_jobs / preview_cache / moderation_checks / recommendation_events を中核に据え、モデル横断で運用。

将来拡張（サブスク・ランキング・多言語）をスキーマで先取り（subscriptions* / ranking_snapshots / prompt_localizations）。

RLS（Row Level Security）を前提に、公開/非公開・本人/管理者のアクセスを明確化できる列＆インデックスを配置。

1. エンティティ一覧（主要テーブル）
1.1 ユーザー・権限

user_profiles

user_id (uuid, PK, FK -> auth.users.id)

display_name (text)

avatar_url (text)

bio (text)

contact (jsonb): { email, url, twitter, … }

role (user|seller|admin) (enum)

is_banned (bool, default false)

created_at (timestamptz, default now())

updated_at (timestamptz)

Index: (role), (is_banned)

seller_payout_accounts

id (uuid, PK)

seller_id (uuid, FK -> user_profiles.user_id)

provider (enum: bank, paypal, paypay, stripe_connect, other)

account_payload (jsonb) 機微情報は秘匿トークン化を想定

verified (bool, default false)

created_at (timestamptz)

updated_at (timestamptz)

1.2 カテゴリ・タグ

categories

id (bigserial, PK)

slug (text, unique)

name (text)

description (text)

parent_id (bigint, FK -> categories.id, null可)

sort_order (int)

Index: (slug) unique, (parent_id)

tags

id (bigserial, PK)

slug (text, unique)

name (text)

Index: (slug) unique

1.3 プロンプト（商品）

prompts

id (uuid, PK)

seller_id (uuid, FK -> user_profiles.user_id)

title (text)

slug (text, unique)

category_id (bigint, FK -> categories.id)

thumbnail_url (text)

price_jpy (integer) ※税込み想定（税別の場合は tax_rate 列を追加）

currency (text, default 'JPY')

short_description (text)

long_description (text)

sample_output (text) ※「出力例」

visibility (enum: public|unlisted|private)

status (enum: draft|published|suspended|deleted)

like_count (int, default 0)（将来UI用）

view_count (int, default 0)

avg_rating (numeric(3,2), default 0)

ratings_count (int, default 0)

created_at (timestamptz)

updated_at (timestamptz)

Indexes: (seller_id), (category_id), (status, visibility), GIN (to_tsvector('japanese', title || ' ' || short_description || ' ' || long_description))（検索用）

prompt_tags (M:N)

prompt_id (uuid, FK -> prompts.id, PK part)

tag_id (bigint, FK -> tags.id, PK part)

Index: (tag_id)

prompt_versions

id (uuid, PK)

prompt_id (uuid, FK -> prompts.id)

version (int) 1,2,3…

title_snapshot (text)

description_snapshot (text)

sample_output_snapshot (text)

content_type (enum: text|file|mixed)

created_at (timestamptz)

published_at (timestamptz, null可) ※販売開始時点

Unique: (prompt_id, version)

Index: (prompt_id)

prompt_assets

id (uuid, PK)

prompt_version_id (uuid, FK -> prompt_versions.id)

kind (enum: text_body|attachment|image|meta)

storage_path (text) ※Supabase Storageのキー

text_content (text) ※content_type=text用

checksum (text) ※改ざん検知

size_bytes (bigint)

created_at (timestamptz)

Index: (prompt_version_id)

prompt_localizations（将来の多言語展開）

id (uuid, PK)

prompt_id (uuid)

locale (text) 例: ja-JP, en-US

title_l10n (text)

short_description_l10n (text)

long_description_l10n (text)

Unique: (prompt_id, locale)

1.4 カート・注文・決済・所有権

carts

id (uuid, PK)

buyer_id (uuid, FK -> user_profiles.user_id, null可) ※未ログインは null

temp_key (text, unique, null可) ※クッキーと紐付け

created_at / updated_at

cart_items

id (uuid, PK)

cart_id (uuid, FK -> carts.id)

prompt_id (uuid, FK -> prompts.id)

unit_price_jpy (int) 追加時点の価格スナップショット

quantity (int, default 1) ※デジタル商材なので通常1

created_at

orders

id (uuid, PK)

buyer_id (uuid, FK -> user_profiles.user_id)

order_number (text, unique) 人間可読

total_amount_jpy (int)

currency (text, default 'JPY')

status (enum: pending|paid|failed|cancelled|refunded)

created_at / updated_at

Index: (buyer_id), (status)

order_items

id (uuid, PK)

order_id (uuid, FK -> orders.id)

prompt_id (uuid, FK -> prompts.id)

prompt_version_id (uuid, FK -> prompt_versions.id) ※購入時点のバージョンを固定

unit_price_jpy (int)

quantity (int, default 1)

created_at

Index: (order_id)

payment_providers

id (smallserial, PK)

code (text, unique) 例: card, paypal, paypay

display_name (text)

fee_percent (numeric(5,2)) ※3.0–4.0%など（運営負担用の参考値）

meta (jsonb)

payments

id (uuid, PK)

order_id (uuid, FK -> orders.id, unique) ※1注文=1決済想定。分割対応ならUnique外す

provider_id (smallint, FK -> payment_providers.id)

provider_txn_id (text) 外部取引ID

amount_jpy (int)

status (enum: pending|authorized|captured|failed|refunded|partially_refunded)

raw_payload (jsonb) Webhook等の生ログ

created_at / updated_at

Indexes: (provider_id), (provider_txn_id)

entitlements（ダウンロード権）

id (uuid, PK)

buyer_id (uuid)

order_item_id (uuid, FK -> order_items.id, unique)

prompt_version_id (uuid, FK -> prompt_versions.id)

granted_at (timestamptz, default now())

用途: 無期限再ダウンロード権の判定はこれを見る

1.5 売上分配・台帳・出金

seller_balances

seller_id (uuid, PK)

available_jpy (bigint, default 0) 引出可能

pending_jpy (bigint, default 0) 清算待ち

updated_at (timestamptz)

ledger_entries

id (bigserial, PK)

entry_type (enum: sale_gross|platform_fee|payment_fee|seller_net|payout|adjustment|refund)

order_id (uuid, null可)

order_item_id (uuid, null可)

seller_id (uuid, FK -> user_profiles.user_id, null可) ※出品者向けエントリのみ設定

amount_jpy (bigint) 正負

note (text)

created_at (timestamptz, default now())

Index: (seller_id), (order_id), (entry_type)

計上ルール（例）

売上発生時: sale_gross +amount, payment_fee -amount, platform_fee -amount, seller_net +amount

出金: payout -amount（available から減算）

payouts

id (uuid, PK)

seller_id (uuid)

payout_account_id (uuid, FK -> seller_payout_accounts.id)

amount_jpy (bigint)

status (enum: requested|processing|paid|failed)

requested_at / processed_at

provider_txn_id (text, null可)

Index: (seller_id), (status)

1.6 レビュー・通報・モデレーション

reviews

id (uuid, PK)

prompt_id (uuid)

buyer_id (uuid)

rating (smallint check 1..5)

comment (text)

status (enum: visible|hidden|removed)

created_at / updated_at

Unique: (prompt_id, buyer_id) ※1購入者1レビュー

Index: (prompt_id), (status)

moderation_checks（AI/人手の審査ログ）

id (uuid, PK)

target_type (enum: prompt|sample_output|review)

target_id (uuid)

method (enum: ai_sdk|manual)

result (enum: pass|flag|reject)

detail (jsonb) ※モデル名/スコア/注釈

checked_by (uuid, FK -> user_profiles.user_id, null可) ※manual時

created_at

Index: (target_type, target_id)

admin_actions

id (uuid, PK)

actor_id (uuid, FK -> user_profiles.user_id) ※admin

action (enum: user_ban|user_unban|prompt_remove|review_remove|refund|other)

target_type (text) / target_id (uuid)

reason (text)

created_at

1.7 AI SDK 連携（プレビュー/推薦/自動タグ）

ai_jobs

id (uuid, PK)

job_type (enum: preview_generate|moderation_analyze|auto_tagging|recommendation_train)

status (enum: queued|running|succeeded|failed)

input_payload (jsonb)

output_payload (jsonb)

model_provider (enum: openai|google|other)

model_name (text)

error_message (text)

created_at / updated_at

Index: (job_type, status)

preview_cache（購入前プレビューのキャッシュ）

id (uuid, PK)

prompt_version_id (uuid)

preview_type (enum: head_lines|truncated_output|masked_text)

content (text) 先頭数行など

generated_by_job (uuid, FK -> ai_jobs.id)

created_at

Unique: (prompt_version_id, preview_type)

recommendation_events

id (bigserial, PK)

user_id (uuid, null可) 未ログインは null

event_type (enum: view|click|add_to_cart|purchase|like)

prompt_id (uuid, null可)

referrer (text, null可)

event_time (timestamptz, default now())

meta (jsonb)

Index: (user_id, event_time), (prompt_id, event_time), (event_type)

auto_tags（AI付与タグ）

id (bigserial, PK)

prompt_id (uuid)

tag_text (text)

confidence (numeric(4,3))

created_at

Index: GIN (to_tsvector('japanese', tag_text)), (prompt_id)

1.8 レポート・ランキング・ログ

ranking_snapshots（期間別ランキング）

id (uuid, PK)

rank_type (enum: sales|views|rating|trending)

period (enum: daily|weekly|monthly)

from_date / to_date (date)

rows (jsonb) [{"rank":1,"prompt_id":"…","score": …}, …]

created_at

Unique: (rank_type, period, from_date, to_date)

audit_logs

id (bigserial, PK)

actor_user_id (uuid, null可)

action (text) 例: orders.create, prompts.update

entity_type (text) / entity_id (uuid)

diff (jsonb)（前後差分）

ip (inet, null可)

created_at

1.9 サブスクリプション（将来機能）

subscription_plans

id (uuid, PK)

name (text)

price_jpy (int)

period (enum: monthly|yearly)

benefits (jsonb) 例: { “unlimited_prompts”: [ids], “discount_percent”: 10 }

status (enum: active|inactive)

subscriptions

id (uuid, PK)

user_id (uuid)

plan_id (uuid)

status (enum: active|past_due|canceled)

current_period_start / current_period_end (timestamptz)

created_at / updated_at

2. 主要ユースケース別データフロー（抜粋）
2.1 購入〜ダウンロード

orders 作成 → payments 成功（captured）

order_items から 当時の prompt_version_id を確定

entitlements 発行（無期限）

ダウンロードは entitlements + prompt_assets（その version のみ）で許可

2.2 売上計上と出品者還元（80%）

決済成功時に ledger_entries を一括記帳：

sale_gross（+総額）

payment_fee（−手数料）※運営負担だが台帳に残す

platform_fee（−運営取り分 20%）

seller_net（+出品者取り分 80%）

日次/即時で seller_balances.available/pending を更新

2.3 AIプレビュー/審査（AI SDK）

プレビュー生成要求 → ai_jobs (preview_generate, queued)

実行後 preview_cache に格納、UIは preview_cache を返却

モデレーション（moderation_checks）で出力例や本文の規約チェック

2.4 レコメンド

recommendation_events を収集

バッチ/オンラインで ai_jobs (recommendation_train) がモデル更新

推薦結果はアプリ層で提示（DBには ranking_snapshots で集計版を残す場合あり）

3. 代表DDL（PostgreSQL方言 | 抜粋）

実装開始用の最小セット（省略列は上記定義を参照）

-- enum例
CREATE TYPE user_role AS ENUM ('user','seller','admin');
CREATE TYPE visibility AS ENUM ('public','unlisted','private');
CREATE TYPE prompt_status AS ENUM ('draft','published','suspended','deleted');

-- user_profiles
CREATE TABLE public.user_profiles (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name text,
  avatar_url text,
  bio text,
  contact jsonb,
  role user_role NOT NULL DEFAULT 'user',
  is_banned boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz
);

-- prompts
CREATE TABLE public.prompts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  seller_id uuid NOT NULL REFERENCES public.user_profiles(user_id) ON DELETE RESTRICT,
  title text NOT NULL,
  slug text UNIQUE,
  category_id bigint REFERENCES public.categories(id),
  thumbnail_url text,
  price_jpy integer NOT NULL CHECK (price_jpy >= 0),
  currency text NOT NULL DEFAULT 'JPY',
  short_description text,
  long_description text,
  sample_output text,
  visibility visibility NOT NULL DEFAULT 'public',
  status prompt_status NOT NULL DEFAULT 'draft',
  like_count int NOT NULL DEFAULT 0,
  view_count int NOT NULL DEFAULT 0,
  avg_rating numeric(3,2) NOT NULL DEFAULT 0,
  ratings_count int NOT NULL DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz
);

-- prompt_versions
CREATE TABLE public.prompt_versions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_id uuid NOT NULL REFERENCES public.prompts(id) ON DELETE CASCADE,
  version int NOT NULL,
  title_snapshot text,
  description_snapshot text,
  sample_output_snapshot text,
  content_type text NOT NULL CHECK (content_type IN ('text','file','mixed')),
  created_at timestamptz NOT NULL DEFAULT now(),
  published_at timestamptz
);
CREATE UNIQUE INDEX ON public.prompt_versions (prompt_id, version);

-- prompt_assets
CREATE TABLE public.prompt_assets (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_version_id uuid NOT NULL REFERENCES public.prompt_versions(id) ON DELETE CASCADE,
  kind text NOT NULL CHECK (kind IN ('text_body','attachment','image','meta')),
  storage_path text,
  text_content text,
  checksum text,
  size_bytes bigint,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- orders
CREATE TYPE order_status AS ENUM ('pending','paid','failed','cancelled','refunded');

CREATE TABLE public.orders (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id uuid NOT NULL REFERENCES public.user_profiles(user_id) ON DELETE RESTRICT,
  order_number text UNIQUE,
  total_amount_jpy int NOT NULL CHECK (total_amount_jpy >= 0),
  currency text NOT NULL DEFAULT 'JPY',
  status order_status NOT NULL DEFAULT 'pending',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz
);

CREATE TABLE public.order_items (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  prompt_id uuid NOT NULL REFERENCES public.prompts(id) ON DELETE RESTRICT,
  prompt_version_id uuid NOT NULL REFERENCES public.prompt_versions(id) ON DELETE RESTRICT,
  unit_price_jpy int NOT NULL CHECK (unit_price_jpy >= 0),
  quantity int NOT NULL DEFAULT 1 CHECK (quantity = 1),
  created_at timestamptz NOT NULL DEFAULT now()
);

-- entitlements（再DL権）
CREATE TABLE public.entitlements (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id uuid NOT NULL REFERENCES public.user_profiles(user_id) ON DELETE CASCADE,
  order_item_id uuid NOT NULL UNIQUE REFERENCES public.order_items(id) ON DELETE CASCADE,
  prompt_version_id uuid NOT NULL REFERENCES public.prompt_versions(id) ON DELETE RESTRICT,
  granted_at timestamptz NOT NULL DEFAULT now()
);

※ 残りDDL（決済・台帳・レビュー・AI・ランキング等）は上記定義に従って同様に作成可能。

4. インデックス設計（検索/集計の要点）

全文検索: prompts に日本語形態素解析を想定した to_tsvector('japanese', …) の GIN。キーワード/説明で高速検索。

並び替え: 人気順= ratings_count DESC, avg_rating DESC、売上順は集計テーブル or ranking_snapshots。

履歴系: recommendation_events(event_time)、ledger_entries(seller_id, created_at) に時系列インデックス。

5. RLS（Row Level Security）ポリシー指針（Supabase）

prompts:

SELECT: visibility='public' は誰でも。seller_id = auth.uid() は本人のみ下書き閲覧可。admin は全件。

INSERT/UPDATE/DELETE: seller_id = auth.uid() に限定。status を published にする操作は本人＋未BANのみ。

prompt_assets, prompt_versions:

SELECT: 公開版は誰でも、私有版は本人/管理者。

ダウンロードAPIは entitlements をJOINして制御。

reviews:

INSERT: entitlements 保有者のみ可。

UPDATE/DELETE(自己レビュー): buyer_id = auth.uid()、管理者は強制 status 変更可。

ledger_entries / seller_balances / payouts:

SELECT: seller_id = auth.uid() のみ。admin は全件。

moderation_checks, admin_actions は admin のみ読み書き。

6. バリデーション／業務ルール（主要）

価格: price_jpy >= 0

レビュー: 1ユーザー×1プロンプトにつき1件（Unique制約）

再ダウンロード: entitlements が存在すれば可。常に購入時点の prompt_version を提供。

売上按分: 80%：20% をロジックで固定。将来は commission_rules テーブル化も可。

決済手数料: 運営負担だが台帳に残す（透明性のため）。

BAN: user_profiles.is_banned=true の場合、prompts の publish 禁止、購入不可。

7. 監査・バックアップ

監査: 重要操作は audit_logs に差分を保存（PIIは避ける）。

バックアップ: 1日1回スナップショット。Storage（実ファイル）も世代管理。

復旧: 24時間以内に entitlements と prompt_assets 整合性が再現できる運用手順を用意。

8. ER図（Mermaid）
erDiagram
  auth_users {
    uuid id PK
  }

  user_profiles {
    uuid user_id PK, FK
    text display_name
    text avatar_url
    text bio
    jsonb contact
    text role
    bool is_banned
  }

  seller_payout_accounts {
    uuid id PK
    uuid seller_id FK
    text provider
    jsonb account_payload
    bool verified
  }

  categories {
    bigint id PK
    text slug
    text name
    text description
    bigint parent_id FK
  }

  tags {
    bigint id PK
    text slug
    text name
  }

  prompts {
    uuid id PK
    uuid seller_id FK
    text title
    text slug
    bigint category_id FK
    int price_jpy
    text currency
    text visibility
    text status
    numeric avg_rating
    int ratings_count
  }

  prompt_tags {
    uuid prompt_id FK
    bigint tag_id FK
  }

  prompt_versions {
    uuid id PK
    uuid prompt_id FK
    int version
    text content_type
  }

  prompt_assets {
    uuid id PK
    uuid prompt_version_id FK
    text kind
    text storage_path
    text text_content
  }

  carts {
    uuid id PK
    uuid buyer_id FK
    text temp_key
  }

  cart_items {
    uuid id PK
    uuid cart_id FK
    uuid prompt_id FK
    int unit_price_jpy
    int quantity
  }

  orders {
    uuid id PK
    uuid buyer_id FK
    text order_number
    int total_amount_jpy
    text status
  }

  order_items {
    uuid id PK
    uuid order_id FK
    uuid prompt_id FK
    uuid prompt_version_id FK
    int unit_price_jpy
  }

  payment_providers {
    smallserial id PK
    text code
  }

  payments {
    uuid id PK
    uuid order_id FK
    smallint provider_id FK
    int amount_jpy
    text status
  }

  entitlements {
    uuid id PK
    uuid buyer_id FK
    uuid order_item_id FK
    uuid prompt_version_id FK
  }

  seller_balances {
    uuid seller_id PK, FK
    bigint available_jpy
    bigint pending_jpy
  }

  ledger_entries {
    bigserial id PK
    uuid seller_id FK
    uuid order_id FK
    uuid order_item_id FK
    bigint amount_jpy
    text entry_type
  }

  payouts {
    uuid id PK
    uuid seller_id FK
    uuid payout_account_id FK
    bigint amount_jpy
    text status
  }

  reviews {
    uuid id PK
    uuid prompt_id FK
    uuid buyer_id FK
    smallint rating
    text status
  }

  moderation_checks {
    uuid id PK
    text target_type
    uuid target_id
    text method
    text result
  }

  ai_jobs {
    uuid id PK
    text job_type
    text status
    jsonb input_payload
    jsonb output_payload
    text model_provider
    text model_name
  }

  preview_cache {
    uuid id PK
    uuid prompt_version_id FK
    text preview_type
    text content
    uuid generated_by_job FK
  }

  recommendation_events {
    bigserial id PK
    uuid user_id
    uuid prompt_id
    text event_type
  }

  ranking_snapshots {
    uuid id PK
    text rank_type
    text period
    date from_date
    date to_date
    jsonb rows
  }

  user_profiles ||--o{ prompts : "seller_id"
  prompts ||--o{ prompt_versions : ""
  prompt_versions ||--o{ prompt_assets : ""
  prompts }o--o{ tags : "prompt_tags"
  user_profiles ||--o{ carts : "buyer_id"
  carts ||--o{ cart_items : ""
  user_profiles ||--o{ orders : "buyer_id"
  orders ||--o{ order_items : ""
  prompts ||--o{ order_items : ""
  prompt_versions ||--o{ order_items : ""
  orders ||--|| payments : ""
  order_items ||--|| entitlements : ""
  user_profiles ||--o{ entitlements : "buyer_id"
  user_profiles ||--|| seller_balances : "seller_id"
  user_profiles ||--o{ seller_payout_accounts : "seller_id"
  user_profiles ||--o{ payouts : "seller_id"
  seller_payout_accounts ||--o{ payouts : ""
  user_profiles ||--o{ reviews : "buyer_id"
  prompts ||--o{ reviews : ""
  user_profiles ||--o{ ledger_entries : "seller_id"
  orders ||--o{ ledger_entries : ""
  order_items ||--o{ ledger_entries : ""
  prompt_versions ||--o{ preview_cache : ""
  ai_jobs ||--o{ preview_cache : "generated_by_job"

9. 実装チェックリスト（開発順の目安）

認証 / RLS 基盤：user_profiles 作成・RLS・管理者ロール付与

商品ドメイン：prompts / prompt_versions / prompt_assets（Storage連携）

検索：全文検索GIN＋カテゴリ／タグJOIN

カート〜注文：carts → orders → payments（Webhook受信）

権利付与：entitlements と再DL API

売上台帳：ledger_entries / seller_balances と還元ロジック

レビュー & モデレーション：reviews / moderation_checks（AI SDK接続）

AIプレビュー：ai_jobs → preview_cache（モデル横断）

レコメンド・ランキング：recommendation_events / ranking_snapshots

出金：payouts / seller_payout_accounts（会計監査ログ含む）

10. 運用メモ（AI SDK活用の落とし穴と対策）

モデル差異（OpenAI / Google / 他）
→ ai_jobs.model_provider/model_name と input/output_payload をそのまま保存して再現性確保。

プレビューの個人情報混入
→ moderation_checks を プレビュー生成後にも必ず実施し、result='pass' のみ preview_cache 公開。

レコメンドのバイアス
→ recommendation_events は匿名IDも蓄積。期間でスナップショット化し公開ランキングと分離。