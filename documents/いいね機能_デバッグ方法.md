# いいね機能 デバッグ方法

## 問題: いいねボタンが赤くなるが、いいね数が増えない

### 確認手順

#### 1. ブラウザの開発者ツールでネットワークを確認

1. **F12キー** を押して開発者ツールを開く
2. **Networkタブ** を選択
3. いいねボタンをクリック
4. `/api/prompts/[slug]/like` のリクエストをクリック
5. **Response** タブでレスポンスを確認

**期待されるレスポンス**:
```json
{
  "success": true,
  "isLiked": true,
  "likeCount": 1
}
```

**エラーの場合**:
```json
{
  "error": "エラーメッセージ"
}
```

#### 2. サーバーログを確認（ターミナル）

開発サーバーのターミナルで以下のようなログが表示されるはず：

```
Like operation completed: {
  isLiked: true,
  likeCount: 1,
  promptId: 'xxxx-xxxx-xxxx'
}
```

エラーがある場合は：
```
Error calling increment_like_count: [エラー詳細]
```

#### 3. データベースの状態を確認

Supabaseダッシュボードで以下を確認：

```sql
-- プロンプトのいいね数
SELECT id, title, like_count 
FROM prompts 
WHERE slug = 'your-slug';

-- ユーザーのいいね状態
SELECT * 
FROM recommendation_events 
WHERE prompt_id = 'prompt-id' 
  AND user_id = 'user-id' 
  AND event_type = 'like';
```

### よくある問題と解決方法

#### 問題1: RPC関数が見つからない

**エラーログ**:
```
Error calling increment_like_count: function does not exist
```

**解決方法**:
Supabaseで以下のSQLを実行：

```sql
-- いいね数を増やす関数
CREATE OR REPLACE FUNCTION increment_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;

-- いいね数を減らす関数
CREATE OR REPLACE FUNCTION decrement_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;
```

#### 問題2: RLSポリシーが設定されていない

**エラーログ**:
```
Error inserting like: new row violates row-level security policy
```

**解決方法**:
Supabaseで以下のSQLを実行：

```sql
-- ユーザーは自分のいいねを閲覧・削除可能
CREATE POLICY "Users can view their own likes" ON public.recommendation_events
  FOR SELECT USING (auth.uid() = user_id AND event_type = 'like');

-- ユーザーは自分のいいねを削除可能
CREATE POLICY "Users can delete their own likes" ON public.recommendation_events
  FOR DELETE USING (auth.uid() = user_id AND event_type = 'like');
```

#### 問題3: 楽観的更新が失敗している

**現象**: ボタンが赤くなるが、すぐに元に戻る

**原因**: APIレスポンスがエラー

**確認方法**:
1. ブラウザのコンソールでエラーログを確認
2. NetworkタブでAPIレスポンスを確認
3. サーバーログを確認

### デバッグコマンド

ターミナルで確認：

```bash
# Next.jsのログを確認
tail -f .next/trace

# または開発サーバーのログを確認
yarn dev
```

### テスト用スクリプト

ブラウザのコンソールで実行してテスト：

```javascript
// いいねを追加
const response = await fetch('/api/prompts/[slug]/like', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
});
const data = await response.json();
console.log('Response:', data);
```

---

**トラブルが解決しない場合**:
1. ブラウザのコンソールを確認
2. サーバーログを確認
3. データベースの状態を確認
4. ネットワークタブでAPIレスポンスを確認

