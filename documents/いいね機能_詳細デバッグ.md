# いいね機能 詳細デバッグガイド

## 問題: コンソールにlikeCountが表示されるが、数が増えない

### 確認手順

#### 1. ブラウザのコンソールを確認

いいねボタンをクリックしたときに表示されるログを確認：

```javascript
Like updated: {
  isLiked: true,
  likeCount: 1  // ← この数値が増えているか確認
}
```

#### 2. サーバーログを確認

ターミナルで以下を確認：

```bash
# Next.jsの開発サーバーログを確認
# サーバー側に以下のログが表示されるはず：

Like operation completed: {
  isLiked: true,
  likeCount: 1,  // ← この数値が正しいか確認
  promptId: 'xxxx-xxxx-xxxx'
}
```

#### 3. ネットワークタブでAPIレスポンスを確認

ブラウザの開発者ツールで：
1. F12 → Networkタブ
2. いいねボタンをクリック
3. `/api/prompts/[slug]/like` をクリック
4. **Response** タブでレスポンスを確認

**期待されるレスポンス**:
```json
{
  "success": true,
  "isLiked": true,
  "likeCount": 1
}
```

**もし `likeCount` が増えていない場合**:
```json
{
  "success": true,
  "isLiked": true,
  "likeCount": 0  // ← 増えていない
}
```

### 問題の原因と解決方法

#### 原因1: RPC関数が失敗している

**サーバーログに以下が表示される場合**:
```
Error calling increment_like_count: function "increment_like_count" does not exist
```

**解決方法**:
Supabaseで以下のSQLを実行：

```sql
-- いいね数を増やす関数
CREATE OR REPLACE FUNCTION increment_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;

-- いいね数を減らす関数
CREATE OR REPLACE FUNCTION decrement_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;
```

#### 原因2: データベースの更新が失敗している

**確認方法**:
```sql
-- プロンプトの現在のいいね数を確認
SELECT id, slug, title, like_count 
FROM prompts 
WHERE slug = 'your-slug';

-- いいねレコードを確認
SELECT * 
FROM recommendation_events 
WHERE prompt_id = (
    SELECT id FROM prompts WHERE slug = 'your-slug'
)
AND event_type = 'like';
```

#### 原因3: RLSポリシーが正しく設定されていない

**確認方法**:
```sql
-- RLSポリシーを確認
SELECT schemaname, tablename, policyname, cmd, qual
FROM pg_policies 
WHERE tablename = 'recommendation_events';
```

**必要最小限のポリシー**:
- `Anyone can insert recommendation events` (INSERT)
- `Users can view their own likes` (SELECT)
- `Users can delete their own likes` (DELETE)

### デバッグ用SQL

以下をSupabaseで実行して、データベースの状態を確認：

```sql
-- 1. プロンプトの現在の状態を確認
SELECT 
  id,
  slug,
  title,
  like_count,
  updated_at
FROM prompts
WHERE slug = 'your-slug';

-- 2. ユーザーのいいね状態を確認
SELECT 
  re.id,
  re.prompt_id,
  re.user_id,
  re.event_type,
  re.event_time
FROM recommendation_events re
JOIN prompts p ON p.id = re.prompt_id
WHERE p.slug = 'your-slug'
  AND re.event_type = 'like';

-- 3. 特定ユーザーのいいねを確認
SELECT *
FROM recommendation_events
WHERE user_id = auth.uid()
  AND event_type = 'like';
```

### 手動テスト

ブラウザのコンソールで直接APIを呼び出してテスト：

```javascript
// 現在のいいね状態を取得
const response = await fetch('/api/prompts/[slug]/like');
const data = await response.json();
console.log('Current state:', data);

// いいねを追加
const likeResponse = await fetch('/api/prompts/[slug]/like', {
  method: 'POST'
});
const likeData = await likeResponse.json();
console.log('After like:', likeData);

// 再度状態を確認
const checkResponse = await fetch('/api/prompts/[slug]/like');
const checkData = await checkResponse.json();
console.log('After check:', checkData);
```

### 完全なデバッグフロー

1. **ブラウザのコンソールを確認**
   - いいねボタンをクリック
   - コンソールに `Like updated:` が表示されることを確認
   - `likeCount` の数値を確認

2. **サーバーログを確認**
   - ターミナルで `Like operation completed` を確認
   - `likeCount` の数値を確認

3. **Network タブを確認**
   - APIレスポンスの `likeCount` を確認

4. **データベースを確認**
   - Supabaseダッシュボードで以下を確認：
     - `prompts` テーブルの `like_count` が増えているか
     - `recommendation_events` テーブルにレコードが追加されているか

### もし問題が解決しない場合

以下を共有してください：

1. ブラウザコンソールの完全なログ
2. サーバーの完全なログ
3. Network タブの API レスポンス
4. データベースのクエリ結果

---

**注意**: 修正後はブラウザをリロード（Cmd+R / Ctrl+R）してください。

