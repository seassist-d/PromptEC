# いいね機能 トラブルシューティング

## 問題: いいねをクリックしても数が更新されない

### 原因
RLS（Row Level Security）ポリシーが不完全だったため、ユーザーが自分のいいねを確認・削除できませんでした。

### 解決方法

#### 1. データベースにRLSポリシーを適用

Supabaseダッシュボードで以下のSQLを実行してください：

```sql
-- 既存のポリシーを削除
DROP POLICY IF EXISTS "Only admins can view all recommendation events" ON public.recommendation_events;
DROP POLICY IF EXISTS "Users can delete their own likes" ON public.recommendation_events;
DROP POLICY IF EXISTS "Users can view their own likes" ON public.recommendation_events;

-- ユーザーは自分のいいねを閲覧・削除可能
CREATE POLICY "Users can view their own likes" ON public.recommendation_events
  FOR SELECT USING (auth.uid() = user_id AND event_type = 'like');

-- ユーザーは自分のいいねを削除可能
CREATE POLICY "Users can delete their own likes" ON public.recommendation_events
  FOR DELETE USING (auth.uid() = user_id AND event_type = 'like');

-- 管理者のみ全推薦イベントを閲覧可能
CREATE POLICY "Only admins can view all recommendation events" ON public.recommendation_events
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.user_profiles 
      WHERE user_id = auth.uid() AND role = 'admin'
    )
  );
```

#### 2. データベース関数を追加

以下の関数がまだない場合は追加：

```sql
-- いいね数を増やす関数
CREATE OR REPLACE FUNCTION increment_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;

-- いいね数を減らす関数
CREATE OR REPLACE FUNCTION decrement_like_count(prompt_id uuid)
RETURNS void AS $$
BEGIN
    UPDATE public.prompts
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE id = prompt_id;
END;
$$ LANGUAGE plpgsql;
```

#### 3. 動作確認

1. プロンプト詳細ページを開く
2. いいねボタンをクリック
3. いいね数が増減することを確認
4. もう一度クリックしていいねが解除されることを確認

### 修正内容の詳細

#### 問題の原因
1. **SELECT権限**: ユーザーが自分のいいねを確認できなかった
2. **DELETE権限**: ユーザーが自分のいいねを削除できなかった
3. その結果、楽観的更新は成功するが、APIから返される値が更新されず、UIが元に戻ってしまう

#### 解決策
- ユーザーが自分のいいねのみ閲覧・削除できるポリシーを追加
- 管理者は全ての推薦イベントを閲覧可能（既存のポリシー）

### テスト方法

ブラウザの開発者ツールでAPIレスポンスを確認：

```javascript
// 1. いいねを追加
fetch('/api/prompts/[slug]/like', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
}).then(r => r.json()).then(console.log);

// 2. いいね状態を確認
fetch('/api/prompts/[slug]/like').then(r => r.json()).then(console.log);
```

期待されるレスポンス:
```json
{
  "success": true,
  "isLiked": true,
  "likeCount": 1
}
```

### 追加のトラブルシューティング

#### エラー: "関数が見つかりません"
- `increment_like_count` と `decrement_like_count` がデータベースに存在しない
- 上記のSQLを実行して関数を追加

#### エラー: "権限がありません"
- RLSポリシーが正しく設定されていない
- 上記のRLSポリシーを適用

#### いいねが表示されない
- ブラウザのコンソールを確認
- ネットワークタブでAPIレスポンスを確認
- 認証状態を確認（ログインしているか）

---

**作成日**: 2024年
**最終更新**: 2024年

