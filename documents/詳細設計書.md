# プロンプト売買ECサイト 詳細設計書

## 1. ドキュメント概要

### 1.1 目的
本設計書は、要件定義書、API設計書、データベース設計書、画面設計書に基づき、プロンプト売買ECサイトの詳細な技術実装設計を定義する。開発者が実装に必要な全ての技術仕様、ファイル構成、実装手順を記載する。

### 1.2 対象システム
- **システム名**: PromptEC（プロンプト売買ECサイト）
- **バージョン**: 1.0
- **開発期間**: 初期実装フェーズ

### 1.3 技術スタック
- **フロントエンド**: React 18.x / Next.js 14.x / TypeScript
- **バックエンド**: Node.js 18.x / Express.js 4.x
- **データベース**: Supabase (PostgreSQL 15.x)
- **認証**: Supabase Auth
- **決済**: Stripe / PayPal / PayPay
- **AI SDK**: OpenAI SDK / Google AI SDK
- **ホスティング**: Vercel (フロント) / Railway (バック)
- **ストレージ**: Supabase Storage

---

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │    │   バックエンド    │    │   データベース    │
│   (Next.js)     │◄──►│   (Express.js)  │◄──►│   (Supabase)    │
│                 │    │                 │    │                 │
│ - React 18      │    │ - Node.js 18    │    │ - PostgreSQL 15 │
│ - TypeScript    │    │ - Express 4     │    │ - RLS           │
│ - Tailwind CSS  │    │ - JWT Auth      │    │ - Storage       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   外部サービス    │    │   AI SDK        │    │   決済サービス    │
│                 │    │                 │    │                 │
│ - Google OAuth  │    │ - OpenAI API    │    │ - Stripe        │
│ - Microsoft     │    │ - Google AI     │    │ - PayPal        │
│ - Apple         │    │ - Claude API    │    │ - PayPay        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 ディレクトリ構成
```
PromptEC_v1/
├── front/                          # フロントエンド
│   ├── app/                        # Next.js App Router
│   ├── components/                 # React コンポーネント
│   ├── lib/                        # ユーティリティ・設定
│   ├── types/                      # TypeScript 型定義
│   ├── hooks/                      # カスタムフック
│   └── styles/                     # スタイルファイル
├── backend/                        # バックエンド
│   ├── src/                        # ソースコード
│   ├── routes/                     # API ルート
│   ├── middleware/                 # ミドルウェア
│   ├── services/                   # ビジネスロジック
│   ├── models/                     # データモデル
│   └── utils/                      # ユーティリティ
├── database/                       # データベース関連
│   ├── migrations/                 # マイグレーション
│   ├── seeds/                      # シードデータ
│   └── functions/                  # PostgreSQL 関数
├── docs/                           # ドキュメント
└── scripts/                        # 開発・デプロイスクリプト
```

---

## 3. フロントエンド詳細設計

### 3.1 技術仕様
- **フレームワーク**: Next.js 14.x (App Router)
- **言語**: TypeScript 5.x
- **スタイリング**: Tailwind CSS 3.x
- **状態管理**: Zustand 4.x
- **フォーム**: React Hook Form 7.x + Zod
- **HTTP クライアント**: Axios 1.x
- **認証**: Supabase Auth Client

### 3.2 ページ構成
```
app/
├── (auth)/                         # 認証関連ページ
│   ├── login/
│   │   └── page.tsx
│   ├── register/
│   │   └── page.tsx
│   └── layout.tsx
├── (dashboard)/                    # ダッシュボード
│   ├── seller/                     # 出品者ダッシュボード
│   │   ├── prompts/
│   │   │   ├── new/
│   │   │   │   └── page.tsx
│   │   │   ├── [id]/
│   │   │   │   └── edit/
│   │   │   │       └── page.tsx
│   │   │   └── page.tsx
│   │   ├── sales/
│   │   │   └── page.tsx
│   │   └── layout.tsx
│   ├── buyer/                      # 購入者ダッシュボード
│   │   ├── orders/
│   │   │   └── page.tsx
│   │   ├── cart/
│   │   │   └── page.tsx
│   │   └── layout.tsx
│   └── admin/                      # 管理者ダッシュボード
│       ├── users/
│       │   └── page.tsx
│       ├── prompts/
│       │   └── page.tsx
│       ├── reports/
│       │   └── page.tsx
│       └── layout.tsx
├── prompts/                        # プロンプト関連
│   ├── [id]/
│   │   └── page.tsx
│   ├── search/
│   │   └── page.tsx
│   └── page.tsx
├── checkout/                       # 決済関連
│   ├── cart/
│   │   └── page.tsx
│   ├── payment/
│   │   └── page.tsx
│   └── success/
│       └── page.tsx
├── profile/                        # プロフィール
│   ├── edit/
│   │   └── page.tsx
│   └── page.tsx
├── layout.tsx                      # ルートレイアウト
├── page.tsx                        # トップページ
└── globals.css                     # グローバルスタイル
```

### 3.3 コンポーネント構成
```
components/
├── ui/                             # 基本UIコンポーネント
│   ├── Button.tsx
│   ├── Input.tsx
│   ├── Modal.tsx
│   ├── Card.tsx
│   ├── Badge.tsx
│   ├── Loading.tsx
│   ├── ErrorBoundary.tsx
│   └── index.ts
├── layout/                         # レイアウトコンポーネント
│   ├── Header.tsx
│   ├── Footer.tsx
│   ├── Sidebar.tsx
│   ├── Navigation.tsx
│   └── Breadcrumb.tsx
├── auth/                           # 認証関連
│   ├── LoginForm.tsx
│   ├── RegisterForm.tsx
│   ├── AuthProvider.tsx
│   └── ProtectedRoute.tsx
├── prompts/                        # プロンプト関連
│   ├── PromptCard.tsx
│   ├── PromptList.tsx
│   ├── PromptDetail.tsx
│   ├── PromptForm.tsx
│   ├── PromptSearch.tsx
│   ├── PromptFilter.tsx
│   └── PromptPreview.tsx
├── cart/                           # カート関連
│   ├── CartItem.tsx
│   ├── CartList.tsx
│   ├── CartSummary.tsx
│   └── AddToCartButton.tsx
├── payment/                        # 決済関連
│   ├── PaymentForm.tsx
│   ├── PaymentMethod.tsx
│   ├── PaymentSummary.tsx
│   └── PaymentSuccess.tsx
├── reviews/                        # レビュー関連
│   ├── ReviewForm.tsx
│   ├── ReviewList.tsx
│   ├── ReviewItem.tsx
│   └── StarRating.tsx
├── admin/                          # 管理者関連
│   ├── UserManagement.tsx
│   ├── PromptManagement.tsx
│   ├── SalesReport.tsx
│   └── AdminDashboard.tsx
└── common/                         # 共通コンポーネント
    ├── SearchBar.tsx
    ├── Pagination.tsx
    ├── FileUpload.tsx
    ├── ImageUpload.tsx
    └── Toast.tsx
```

### 3.4 状態管理
```
stores/
├── authStore.ts                    # 認証状態
├── cartStore.ts                    # カート状態
├── promptStore.ts                  # プロンプト状態
├── userStore.ts                    # ユーザー状態
└── uiStore.ts                      # UI状態
```

### 3.5 型定義
```
types/
├── auth.ts                         # 認証関連型
├── prompt.ts                       # プロンプト関連型
├── order.ts                        # 注文関連型
├── payment.ts                      # 決済関連型
├── user.ts                         # ユーザー関連型
├── api.ts                          # API関連型
└── common.ts                       # 共通型
```

### 3.6 カスタムフック
```
hooks/
├── useAuth.ts                      # 認証フック
├── useCart.ts                      # カートフック
├── usePrompts.ts                   # プロンプトフック
├── useOrders.ts                    # 注文フック
├── usePayment.ts                   # 決済フック
├── useUpload.ts                    # アップロードフック
└── useDebounce.ts                  # デバウンスフック
```

---

## 4. バックエンド詳細設計

### 4.1 技術仕様
- **ランタイム**: Node.js 18.x
- **フレームワーク**: Express.js 4.x
- **言語**: TypeScript 5.x
- **認証**: JWT + Supabase Auth
- **バリデーション**: Joi 17.x
- **ORM**: Prisma 5.x
- **ファイルアップロード**: Multer 1.x
- **決済**: Stripe SDK / PayPal SDK
- **AI SDK**: OpenAI SDK / Google AI SDK

### 4.2 ディレクトリ構成
```
backend/
├── src/
│   ├── controllers/                # コントローラー
│   │   ├── authController.ts
│   │   ├── promptController.ts
│   │   ├── orderController.ts
│   │   ├── paymentController.ts
│   │   ├── userController.ts
│   │   ├── reviewController.ts
│   │   └── adminController.ts
│   ├── services/                    # ビジネスロジック
│   │   ├── authService.ts
│   │   ├── promptService.ts
│   │   ├── orderService.ts
│   │   ├── paymentService.ts
│   │   ├── userService.ts
│   │   ├── reviewService.ts
│   │   ├── aiService.ts
│   │   └── emailService.ts
│   ├── models/                     # データモデル
│   │   ├── User.ts
│   │   ├── Prompt.ts
│   │   ├── Order.ts
│   │   ├── Payment.ts
│   │   ├── Review.ts
│   │   └── index.ts
│   ├── middleware/                  # ミドルウェア
│   │   ├── auth.ts
│   │   ├── validation.ts
│   │   ├── errorHandler.ts
│   │   ├── rateLimiter.ts
│   │   ├── cors.ts
│   │   └── upload.ts
│   ├── routes/                     # ルート定義
│   │   ├── auth.ts
│   │   ├── prompts.ts
│   │   ├── orders.ts
│   │   ├── payments.ts
│   │   ├── users.ts
│   │   ├── reviews.ts
│   │   ├── admin.ts
│   │   └── index.ts
│   ├── utils/                       # ユーティリティ
│   │   ├── logger.ts
│   │   ├── database.ts
│   │   ├── encryption.ts
│   │   ├── validation.ts
│   │   ├── fileUpload.ts
│   │   └── constants.ts
│   ├── config/                     # 設定
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   ├── stripe.ts
│   │   ├── supabase.ts
│   │   └── ai.ts
│   ├── types/                       # 型定義
│   │   ├── auth.ts
│   │   ├── prompt.ts
│   │   ├── order.ts
│   │   ├── payment.ts
│   │   └── common.ts
│   ├── jobs/                        # バックグラウンドジョブ
│   │   ├── aiJobProcessor.ts
│   │   ├── emailJobProcessor.ts
│   │   └── cleanupJobProcessor.ts
│   └── app.ts                       # アプリケーションエントリーポイント
├── prisma/                          # Prisma設定
│   ├── schema.prisma
│   ├── migrations/
│   └── seed.ts
├── tests/                           # テスト
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── docs/                            # API仕様書
│   └── api.yaml
└── package.json
```

### 4.3 API エンドポイント詳細

#### 4.3.1 認証関連 (`/api/auth`)
```
POST   /register                    # ユーザー登録
POST   /login                       # ログイン
POST   /logout                      # ログアウト
POST   /refresh                     # トークンリフレッシュ
POST   /forgot-password             # パスワードリセット
POST   /reset-password              # パスワードリセット実行
GET    /verify-email                # メール認証
POST   /oauth/google                # Google OAuth
POST   /oauth/microsoft             # Microsoft OAuth
POST   /oauth/apple                 # Apple OAuth
```

#### 4.3.2 プロンプト関連 (`/api/prompts`)
```
GET    /                           # プロンプト一覧・検索
POST   /                           # プロンプト作成
GET    /:id                        # プロンプト詳細
PUT    /:id                        # プロンプト更新
DELETE /:id                        # プロンプト削除
POST   /:id/like                   # いいね
POST   /:id/preview                # プレビュー生成
GET    /:id/reviews                # レビュー一覧
POST   /:id/reviews                # レビュー投稿
```

#### 4.3.3 注文関連 (`/api/orders`)
```
GET    /                           # 注文履歴
POST   /                           # 注文作成
GET    /:id                        # 注文詳細
POST   /:id/cancel                 # 注文キャンセル
GET    /:id/download/:promptId     # ダウンロード
```

#### 4.3.4 決済関連 (`/api/payments`)
```
POST   /setup                      # 決済設定
POST   /:orderId/process           # 決済実行
POST   /webhook/stripe             # Stripe Webhook
POST   /webhook/paypal             # PayPal Webhook
POST   /webhook/paypay             # PayPay Webhook
GET    /methods                    # 決済方法一覧
```

#### 4.3.5 ユーザー関連 (`/api/users`)
```
GET    /profile                    # プロフィール取得
PUT    /profile                    # プロフィール更新
POST   /avatar                     # アバターアップロード
GET    /sales                      # 売上履歴
GET    /balance                    # 残高確認
POST   /payout                     # 出金申請
```

#### 4.3.6 管理者関連 (`/api/admin`)
```
GET    /dashboard                  # ダッシュボード
GET    /users                      # ユーザー一覧
PUT    /users/:id/ban              # ユーザーBAN
GET    /prompts                    # プロンプト管理
PUT    /prompts/:id/approve        # プロンプト承認
GET    /reports/sales              # 売上レポート
GET    /reports/users              # ユーザーレポート
```

### 4.4 データベース接続
```typescript
// Prisma設定
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 主要モデル定義
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatar    String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // リレーション
  prompts   Prompt[]
  orders    Order[]
  reviews   Review[]
  
  @@map("users")
}

model Prompt {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Int
  content     String
  status      PromptStatus @default(DRAFT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // リレーション
  sellerId    String
  seller      User     @relation(fields: [sellerId], references: [id])
  orders      OrderItem[]
  reviews     Review[]
  
  @@map("prompts")
}
```

---

## 5. データベース詳細設計

### 5.1 Supabase設定
```sql
-- RLS (Row Level Security) 設定例
-- prompts テーブル
CREATE POLICY "Public prompts are viewable by everyone" ON prompts
  FOR SELECT USING (status = 'published');

CREATE POLICY "Users can view their own prompts" ON prompts
  FOR SELECT USING (auth.uid() = seller_id);

CREATE POLICY "Users can insert their own prompts" ON prompts
  FOR INSERT WITH CHECK (auth.uid() = seller_id);

CREATE POLICY "Users can update their own prompts" ON prompts
  FOR UPDATE USING (auth.uid() = seller_id);

-- orders テーブル
CREATE POLICY "Users can view their own orders" ON orders
  FOR SELECT USING (auth.uid() = buyer_id);

CREATE POLICY "Users can create orders" ON orders
  FOR INSERT WITH CHECK (auth.uid() = buyer_id);
```

### 5.2 主要テーブル設計
```sql
-- ユーザープロフィール
CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT,
  avatar_url TEXT,
  bio TEXT,
  contact JSONB,
  role user_role NOT NULL DEFAULT 'user',
  is_banned BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

-- プロンプト
CREATE TABLE prompts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  seller_id UUID NOT NULL REFERENCES user_profiles(user_id) ON DELETE RESTRICT,
  title TEXT NOT NULL,
  slug TEXT UNIQUE,
  category_id BIGINT REFERENCES categories(id),
  thumbnail_url TEXT,
  price_jpy INTEGER NOT NULL CHECK (price_jpy >= 0),
  currency TEXT NOT NULL DEFAULT 'JPY',
  short_description TEXT,
  long_description TEXT,
  sample_output TEXT,
  visibility visibility NOT NULL DEFAULT 'public',
  status prompt_status NOT NULL DEFAULT 'draft',
  like_count INTEGER NOT NULL DEFAULT 0,
  view_count INTEGER NOT NULL DEFAULT 0,
  avg_rating NUMERIC(3,2) NOT NULL DEFAULT 0,
  ratings_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

-- 注文
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES user_profiles(user_id) ON DELETE RESTRICT,
  order_number TEXT UNIQUE,
  total_amount_jpy INTEGER NOT NULL CHECK (total_amount_jpy >= 0),
  currency TEXT NOT NULL DEFAULT 'JPY',
  status order_status NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

-- 決済
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL UNIQUE REFERENCES orders(id) ON DELETE CASCADE,
  provider_id SMALLINT NOT NULL REFERENCES payment_providers(id),
  provider_txn_id TEXT,
  amount_jpy INTEGER NOT NULL CHECK (amount_jpy >= 0),
  status payment_status NOT NULL DEFAULT 'pending',
  raw_payload JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);
```

---

## 6. AI SDK統合設計

### 6.1 OpenAI SDK統合
```typescript
// services/aiService.ts
import OpenAI from 'openai';

export class AIService {
  private openai: OpenAI;
  private googleAI: any;

  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
  }

  // プロンプトプレビュー生成
  async generatePreview(promptText: string): Promise<string> {
    try {
      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "プロンプトの最初の数行を生成してください。"
          },
          {
            role: "user",
            content: promptText
          }
        ],
        max_tokens: 200,
        temperature: 0.7,
      });

      return response.choices[0].message.content || '';
    } catch (error) {
      console.error('OpenAI API Error:', error);
      throw new Error('プレビュー生成に失敗しました');
    }
  }

  // 自動タグ付け
  async generateTags(promptText: string): Promise<string[]> {
    try {
      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "プロンプトの内容を分析して、適切なタグを5つ以内で生成してください。"
          },
          {
            role: "user",
            content: promptText
          }
        ],
        max_tokens: 100,
        temperature: 0.3,
      });

      const tags = response.choices[0].message.content?.split(',').map(tag => tag.trim()) || [];
      return tags;
    } catch (error) {
      console.error('Tag generation error:', error);
      return [];
    }
  }

  // コンテンツモデレーション
  async moderateContent(content: string): Promise<boolean> {
    try {
      const response = await this.openai.moderations.create({
        input: content,
      });

      return !response.results[0].flagged;
    } catch (error) {
      console.error('Moderation error:', error);
      return true; // エラー時は許可
    }
  }
}
```

### 6.2 バックグラウンドジョブ
```typescript
// jobs/aiJobProcessor.ts
import { Queue } from 'bull';
import { AIService } from '../services/aiService';

export class AIJobProcessor {
  private aiService: AIService;
  private aiQueue: Queue;

  constructor() {
    this.aiService = new AIService();
    this.aiQueue = new Queue('AI processing');
  }

  // プレビュー生成ジョブ
  async processPreviewJob(jobData: any) {
    const { promptId, promptText } = jobData;
    
    try {
      const preview = await this.aiService.generatePreview(promptText);
      
      // データベースに保存
      await this.savePreview(promptId, preview);
      
      return { success: true, preview };
    } catch (error) {
      console.error('Preview generation failed:', error);
      throw error;
    }
  }

  // 自動タグ付けジョブ
  async processTaggingJob(jobData: any) {
    const { promptId, promptText } = jobData;
    
    try {
      const tags = await this.aiService.generateTags(promptText);
      
      // データベースに保存
      await this.saveTags(promptId, tags);
      
      return { success: true, tags };
    } catch (error) {
      console.error('Tag generation failed:', error);
      throw error;
    }
  }
}
```

---

## 7. 決済システム設計

### 7.1 Stripe統合
```typescript
// services/paymentService.ts
import Stripe from 'stripe';

export class PaymentService {
  private stripe: Stripe;

  constructor() {
    this.stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
      apiVersion: '2023-10-16',
    });
  }

  // 決済セッション作成
  async createPaymentSession(orderId: string, amount: number, currency: string = 'jpy') {
    try {
      const session = await this.stripe.checkout.sessions.create({
        payment_method_types: ['card'],
        line_items: [
          {
            price_data: {
              currency: currency,
              product_data: {
                name: 'プロンプト購入',
              },
              unit_amount: amount,
            },
            quantity: 1,
          },
        ],
        mode: 'payment',
        success_url: `${process.env.FRONTEND_URL}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${process.env.FRONTEND_URL}/checkout/cancel`,
        metadata: {
          orderId: orderId,
        },
      });

      return session;
    } catch (error) {
      console.error('Stripe session creation failed:', error);
      throw new Error('決済セッションの作成に失敗しました');
    }
  }

  // Webhook処理
  async handleWebhook(signature: string, payload: string) {
    try {
      const event = this.stripe.webhooks.constructEvent(
        payload,
        signature,
        process.env.STRIPE_WEBHOOK_SECRET!
      );

      switch (event.type) {
        case 'checkout.session.completed':
          await this.handlePaymentSuccess(event.data.object);
          break;
        case 'payment_intent.payment_failed':
          await this.handlePaymentFailure(event.data.object);
          break;
      }

      return { received: true };
    } catch (error) {
      console.error('Webhook processing failed:', error);
      throw error;
    }
  }
}
```

### 7.2 PayPal統合
```typescript
// services/paypalService.ts
import paypal from '@paypal/checkout-server-sdk';

export class PayPalService {
  private client: paypal.core.PayPalHttpClient;

  constructor() {
    const environment = new paypal.core.SandboxEnvironment(
      process.env.PAYPAL_CLIENT_ID!,
      process.env.PAYPAL_CLIENT_SECRET!
    );
    this.client = new paypal.core.PayPalHttpClient(environment);
  }

  // PayPal決済作成
  async createPayment(amount: number, currency: string = 'JPY') {
    const request = new paypal.orders.OrdersCreateRequest();
    request.prefer("return=representation");
    request.requestBody({
      intent: 'CAPTURE',
      purchase_units: [
        {
          amount: {
            currency_code: currency,
            value: (amount / 100).toFixed(2), // PayPalは小数点形式
          },
        },
      ],
    });

    try {
      const response = await this.client.execute(request);
      return response.result;
    } catch (error) {
      console.error('PayPal payment creation failed:', error);
      throw error;
    }
  }
}
```

---

## 8. セキュリティ設計

### 8.1 認証・認可
```typescript
// middleware/auth.ts
import jwt from 'jsonwebtoken';
import { Request, Response, NextFunction } from 'express';

export interface AuthRequest extends Request {
  user?: {
    id: string;
    email: string;
    role: string;
  };
}

export const authenticateToken = (req: AuthRequest, res: Response, next: NextFunction) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'アクセストークンが必要です' });
  }

  jwt.verify(token, process.env.JWT_SECRET!, (err, user) => {
    if (err) {
      return res.status(403).json({ error: '無効なトークンです' });
    }
    req.user = user as any;
    next();
  });
};

export const requireRole = (roles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      return res.status(401).json({ error: '認証が必要です' });
    }

    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: '権限がありません' });
    }

    next();
  };
};
```

### 8.2 レート制限
```typescript
// middleware/rateLimiter.ts
import rateLimit from 'express-rate-limit';

export const createRateLimit = (windowMs: number, max: number, message: string) => {
  return rateLimit({
    windowMs,
    max,
    message: { error: message },
    standardHeaders: true,
    legacyHeaders: false,
  });
};

// 使用例
export const authLimiter = createRateLimit(
  15 * 60 * 1000, // 15分
  5, // 5回まで
  '認証試行回数が上限に達しました。15分後に再試行してください。'
);

export const apiLimiter = createRateLimit(
  15 * 60 * 1000, // 15分
  100, // 100回まで
  'API呼び出し回数が上限に達しました。15分後に再試行してください。'
);
```

### 8.3 入力検証
```typescript
// middleware/validation.ts
import Joi from 'joi';

export const validateRequest = (schema: Joi.ObjectSchema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const { error } = schema.validate(req.body);
    
    if (error) {
      return res.status(400).json({
        error: '入力データが無効です',
        details: error.details.map(detail => detail.message)
      });
    }
    
    next();
  };
};

// バリデーションスキーマ例
export const promptSchema = Joi.object({
  title: Joi.string().min(1).max(100).required(),
  description: Joi.string().min(1).max(1000).required(),
  price: Joi.number().integer().min(0).max(100000).required(),
  content: Joi.string().min(1).max(10000).required(),
  categoryId: Joi.string().uuid().required(),
  tags: Joi.array().items(Joi.string().max(50)).max(10),
});
```

---

## 9. ファイル構成（全ファイル一覧）

### 9.1 フロントエンドファイル
```
front/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   │   └── page.tsx
│   │   ├── register/
│   │   │   └── page.tsx
│   │   └── layout.tsx
│   ├── (dashboard)/
│   │   ├── seller/
│   │   │   ├── prompts/
│   │   │   │   ├── new/
│   │   │   │   │   └── page.tsx
│   │   │   │   ├── [id]/
│   │   │   │   │   └── edit/
│   │   │   │   │       └── page.tsx
│   │   │   │   └── page.tsx
│   │   │   ├── sales/
│   │   │   │   └── page.tsx
│   │   │   └── layout.tsx
│   │   ├── buyer/
│   │   │   ├── orders/
│   │   │   │   └── page.tsx
│   │   │   ├── cart/
│   │   │   │   └── page.tsx
│   │   │   └── layout.tsx
│   │   └── admin/
│   │       ├── users/
│   │       │   └── page.tsx
│   │       ├── prompts/
│   │       │   └── page.tsx
│   │       ├── reports/
│   │       │   └── page.tsx
│   │       └── layout.tsx
│   ├── prompts/
│   │   ├── [id]/
│   │   │   └── page.tsx
│   │   ├── search/
│   │   │   └── page.tsx
│   │   └── page.tsx
│   ├── checkout/
│   │   ├── cart/
│   │   │   └── page.tsx
│   │   ├── payment/
│   │   │   └── page.tsx
│   │   └── success/
│   │       └── page.tsx
│   ├── profile/
│   │   ├── edit/
│   │   │   └── page.tsx
│   │   └── page.tsx
│   ├── layout.tsx
│   ├── page.tsx
│   └── globals.css
├── components/
│   ├── ui/
│   │   ├── Button.tsx
│   │   ├── Input.tsx
│   │   ├── Modal.tsx
│   │   ├── Card.tsx
│   │   ├── Badge.tsx
│   │   ├── Loading.tsx
│   │   ├── ErrorBoundary.tsx
│   │   └── index.ts
│   ├── layout/
│   │   ├── Header.tsx
│   │   ├── Footer.tsx
│   │   ├── Sidebar.tsx
│   │   ├── Navigation.tsx
│   │   └── Breadcrumb.tsx
│   ├── auth/
│   │   ├── LoginForm.tsx
│   │   ├── RegisterForm.tsx
│   │   ├── AuthProvider.tsx
│   │   └── ProtectedRoute.tsx
│   ├── prompts/
│   │   ├── PromptCard.tsx
│   │   ├── PromptList.tsx
│   │   ├── PromptDetail.tsx
│   │   ├── PromptForm.tsx
│   │   ├── PromptSearch.tsx
│   │   ├── PromptFilter.tsx
│   │   └── PromptPreview.tsx
│   ├── cart/
│   │   ├── CartItem.tsx
│   │   ├── CartList.tsx
│   │   ├── CartSummary.tsx
│   │   └── AddToCartButton.tsx
│   ├── payment/
│   │   ├── PaymentForm.tsx
│   │   ├── PaymentMethod.tsx
│   │   ├── PaymentSummary.tsx
│   │   └── PaymentSuccess.tsx
│   ├── reviews/
│   │   ├── ReviewForm.tsx
│   │   ├── ReviewList.tsx
│   │   ├── ReviewItem.tsx
│   │   └── StarRating.tsx
│   ├── admin/
│   │   ├── UserManagement.tsx
│   │   ├── PromptManagement.tsx
│   │   ├── SalesReport.tsx
│   │   └── AdminDashboard.tsx
│   └── common/
│       ├── SearchBar.tsx
│       ├── Pagination.tsx
│       ├── FileUpload.tsx
│       ├── ImageUpload.tsx
│       └── Toast.tsx
├── lib/
│   ├── supabase.ts
│   ├── database.types.ts
│   ├── auth.ts
│   ├── api.ts
│   ├── utils.ts
│   ├── constants.ts
│   └── validations.ts
├── hooks/
│   ├── useAuth.ts
│   ├── useCart.ts
│   ├── usePrompts.ts
│   ├── useOrders.ts
│   ├── usePayment.ts
│   ├── useUpload.ts
│   └── useDebounce.ts
├── stores/
│   ├── authStore.ts
│   ├── cartStore.ts
│   ├── promptStore.ts
│   ├── userStore.ts
│   └── uiStore.ts
├── types/
│   ├── auth.ts
│   ├── prompt.ts
│   ├── order.ts
│   ├── payment.ts
│   ├── user.ts
│   ├── api.ts
│   └── common.ts
├── styles/
│   ├── globals.css
│   ├── components.css
│   └── utilities.css
├── public/
│   ├── images/
│   │   ├── logo.svg
│   │   ├── placeholder.png
│   │   └── icons/
│   ├── favicon.ico
│   └── manifest.json
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── package.json
└── README.md
```

### 9.2 バックエンドファイル
```
backend/
├── src/
│   ├── controllers/
│   │   ├── authController.ts
│   │   ├── promptController.ts
│   │   ├── orderController.ts
│   │   ├── paymentController.ts
│   │   ├── userController.ts
│   │   ├── reviewController.ts
│   │   └── adminController.ts
│   ├── services/
│   │   ├── authService.ts
│   │   ├── promptService.ts
│   │   ├── orderService.ts
│   │   ├── paymentService.ts
│   │   ├── userService.ts
│   │   ├── reviewService.ts
│   │   ├── aiService.ts
│   │   ├── emailService.ts
│   │   └── fileService.ts
│   ├── models/
│   │   ├── User.ts
│   │   ├── Prompt.ts
│   │   ├── Order.ts
│   │   ├── Payment.ts
│   │   ├── Review.ts
│   │   ├── Category.ts
│   │   ├── Tag.ts
│   │   └── index.ts
│   ├── middleware/
│   │   ├── auth.ts
│   │   ├── validation.ts
│   │   ├── errorHandler.ts
│   │   ├── rateLimiter.ts
│   │   ├── cors.ts
│   │   ├── upload.ts
│   │   └── logger.ts
│   ├── routes/
│   │   ├── auth.ts
│   │   ├── prompts.ts
│   │   ├── orders.ts
│   │   ├── payments.ts
│   │   ├── users.ts
│   │   ├── reviews.ts
│   │   ├── admin.ts
│   │   └── index.ts
│   ├── utils/
│   │   ├── logger.ts
│   │   ├── database.ts
│   │   ├── encryption.ts
│   │   ├── validation.ts
│   │   ├── fileUpload.ts
│   │   ├── email.ts
│   │   ├── constants.ts
│   │   └── helpers.ts
│   ├── config/
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   ├── stripe.ts
│   │   ├── supabase.ts
│   │   ├── ai.ts
│   │   ├── email.ts
│   │   └── index.ts
│   ├── types/
│   │   ├── auth.ts
│   │   ├── prompt.ts
│   │   ├── order.ts
│   │   ├── payment.ts
│   │   ├── user.ts
│   │   ├── api.ts
│   │   └── common.ts
│   ├── jobs/
│   │   ├── aiJobProcessor.ts
│   │   ├── emailJobProcessor.ts
│   │   ├── cleanupJobProcessor.ts
│   │   └── queue.ts
│   ├── app.ts
│   └── server.ts
├── prisma/
│   ├── schema.prisma
│   ├── migrations/
│   │   ├── 20240101000000_init/
│   │   │   └── migration.sql
│   │   ├── 20240101000001_add_indexes/
│   │   │   └── migration.sql
│   │   └── 20240101000002_add_rls/
│   │       └── migration.sql
│   └── seed.ts
├── tests/
│   ├── unit/
│   │   ├── controllers/
│   │   ├── services/
│   │   └── utils/
│   ├── integration/
│   │   ├── auth.test.ts
│   │   ├── prompts.test.ts
│   │   ├── orders.test.ts
│   │   └── payments.test.ts
│   ├── e2e/
│   │   ├── auth.e2e.ts
│   │   ├── purchase.e2e.ts
│   │   └── admin.e2e.ts
│   ├── fixtures/
│   │   ├── users.json
│   │   ├── prompts.json
│   │   └── orders.json
│   └── helpers/
│       ├── testHelpers.ts
│       └── mockData.ts
├── docs/
│   ├── api.yaml
│   ├── README.md
│   └── deployment.md
├── scripts/
│   ├── setup.sh
│   ├── deploy.sh
│   ├── backup.sh
│   └── migrate.ts
├── .env.example
├── .gitignore
├── package.json
├── tsconfig.json
├── jest.config.js
└── README.md
```

### 9.3 データベースファイル
```
database/
├── migrations/
│   ├── 001_create_users.sql
│   ├── 002_create_categories.sql
│   ├── 003_create_prompts.sql
│   ├── 004_create_orders.sql
│   ├── 005_create_payments.sql
│   ├── 006_create_reviews.sql
│   ├── 007_create_ai_jobs.sql
│   ├── 008_create_indexes.sql
│   └── 009_create_rls_policies.sql
├── seeds/
│   ├── categories.sql
│   ├── tags.sql
│   ├── sample_users.sql
│   └── sample_prompts.sql
├── functions/
│   ├── update_prompt_stats.sql
│   ├── calculate_seller_balance.sql
│   ├── generate_order_number.sql
│   └── cleanup_expired_sessions.sql
├── triggers/
│   ├── update_prompt_rating.sql
│   ├── update_user_stats.sql
│   └── audit_log.sql
└── views/
    ├── prompt_stats.sql
    ├── seller_dashboard.sql
    └── admin_reports.sql
```

### 9.4 設定・ドキュメントファイル
```
docs/
├── 要件定義.md
├── API設計.md
├── データベース設計書.md
├── 画面設計書.md
├── 詳細設計書.md
├── セキュリティ設計書.md
├── テスト設計書.md
├── 運用設計書.md
└── README.md

scripts/
├── development/
│   ├── setup-dev.sh
│   ├── start-dev.sh
│   └── reset-dev.sh
├── deployment/
│   ├── deploy-frontend.sh
│   ├── deploy-backend.sh
│   ├── deploy-database.sh
│   └── rollback.sh
├── maintenance/
│   ├── backup-database.sh
│   ├── restore-database.sh
│   ├── cleanup-logs.sh
│   └── monitor-health.sh
└── testing/
    ├── run-tests.sh
    ├── generate-coverage.sh
    └── e2e-tests.sh
```

---

## 10. 実装手順

### 10.1 Phase 1: 基盤構築（1-2週間）
1. **プロジェクト初期化**
   - Next.js プロジェクト作成
   - Express.js プロジェクト作成
   - Supabase プロジェクト設定
   - 基本的なディレクトリ構成

2. **認証システム実装**
   - Supabase Auth 設定
   - ログイン・登録画面
   - JWT トークン管理
   - 認証ミドルウェア

3. **データベース設計**
   - Prisma スキーマ定義
   - マイグレーション実行
   - RLS ポリシー設定
   - シードデータ投入

### 10.2 Phase 2: コア機能実装（2-3週間）
1. **プロンプト管理**
   - プロンプト CRUD 操作
   - ファイルアップロード
   - カテゴリ・タグ管理
   - 検索・フィルタリング

2. **注文・決済システム**
   - カート機能
   - 注文作成
   - Stripe 決済統合
   - 決済完了処理

3. **ユーザー管理**
   - プロフィール編集
   - 購入履歴
   - 売上管理（出品者）

### 10.3 Phase 3: 高度機能実装（2-3週間）
1. **AI SDK 統合**
   - OpenAI API 統合
   - プレビュー生成
   - 自動タグ付け
   - コンテンツモデレーション

2. **レビュー・評価システム**
   - レビュー投稿
   - 星評価
   - レビュー管理

3. **管理者機能**
   - ダッシュボード
   - ユーザー管理
   - プロンプト審査
   - 売上レポート

### 10.4 Phase 4: 最適化・テスト（1-2週間）
1. **パフォーマンス最適化**
   - キャッシュ実装
   - 画像最適化
   - データベース最適化

2. **セキュリティ強化**
   - レート制限
   - 入力検証
   - セキュリティヘッダー

3. **テスト実装**
   - ユニットテスト
   - 統合テスト
   - E2Eテスト

---

## 11. 品質管理

### 11.1 コード品質
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット
- **TypeScript**: 型安全性
- **Husky**: Git フック
- **lint-staged**: ステージング前チェック

### 11.2 テスト戦略
- **ユニットテスト**: Jest + React Testing Library
- **統合テスト**: Supertest
- **E2Eテスト**: Playwright
- **カバレッジ**: 80% 以上を目標

### 11.3 セキュリティ
- **OWASP Top 10** 対応
- **依存関係スキャン**: npm audit
- **シークレットスキャン**: GitGuardian
- **脆弱性スキャン**: Snyk

---

## 12. 運用・監視

### 12.1 ログ管理
- **アプリケーションログ**: Winston
- **アクセスログ**: Morgan
- **エラーログ**: Sentry
- **パフォーマンスログ**: New Relic

### 12.2 監視
- **ヘルスチェック**: `/health` エンドポイント
- **メトリクス**: Prometheus + Grafana
- **アラート**: Slack 通知
- **バックアップ**: 日次自動バックアップ

### 12.3 デプロイメント
- **フロントエンド**: Vercel
- **バックエンド**: Railway
- **データベース**: Supabase
- **CI/CD**: GitHub Actions

---

## 13. 今後の拡張計画

### 13.1 短期拡張（3-6ヶ月）
- **多言語対応**: 英語版追加
- **モバイルアプリ**: React Native
- **サブスクリプション**: 月額制プラン
- **レコメンド機能**: AI による推薦

### 13.2 中期拡張（6-12ヶ月）
- **API マーケットプレイス**: 外部開発者向け
- **企業向け機能**: チーム管理
- **分析ダッシュボード**: 詳細分析
- **チャット機能**: 出品者・購入者間

### 13.3 長期拡張（1年以上）
- **ブロックチェーン統合**: NFT 対応
- **AI アシスタント**: チャットボット
- **国際展開**: 複数国対応
- **エコシステム拡張**: プラグイン機能

---

## 14. まとめ

本詳細設計書では、プロンプト売買ECサイトの技術実装に必要な全ての要素を定義しました。要件定義から実装まで一貫した設計により、効率的な開発と高品質なシステム構築が可能になります。

### 主要なポイント
- **モダンな技術スタック**: React/Next.js + Node.js/Express + Supabase
- **セキュアな設計**: JWT認証 + RLS + レート制限
- **スケーラブルな構成**: マイクロサービス指向 + クラウドネイティブ
- **AI統合**: OpenAI/Google AI SDK による高度機能
- **包括的なテスト**: ユニット・統合・E2E テスト

この設計書に基づいて開発を進めることで、要件を満たす高品質なプロンプト売買ECサイトを構築できます。

---

**作成日**: 2024年1月15日  
**バージョン**: 1.0  
**承認**: [承認者名]  
**次回更新予定**: 2024年2月15日
